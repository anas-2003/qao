<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantix - إدارة المخزون</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', 'Tajawal', sans-serif; /* Changed font */
            margin: 0;
            background-color: #f3f4f6;
        }
        html, body {
            height: 100%;
            overflow: hidden; 
        }

        .main-content-area {
            overflow-y: auto; overflow-x: hidden; /* تمت إضافة overflow-x: hidden لإزالة شريط التمرير الأفقي */
            height: calc(100vh - 80px); /* Adjust based on top bar height */
            padding-top: 80px; /* Space for the fixed top bar */
            padding-right: 240px; /* Space for the fixed sidebar */
        }

        /* Hide sections by default, JavaScript will show the active one */
        .section-content {
            display: none;
        }
        .section-content.active {
            display: block;
        }

        /* Printer styles */
        @media print {
            /* When body has .print-mode-active, hide everything except the report */
            body.print-mode-active header,
            body.print-mode-active aside,
            body.print-mode-active .main-content-area > .section-content:not(#reports-section),
            body.print-mode-active #modals-container, /* Hide modals */
            body.print-mode-active #toast-container   /* Hide toasts */
             {
                display: none !important;
            }

            body.print-mode-active .main-content-area {
                padding: 0 !important;
                margin: 0 !important;
                height: auto !important;
                overflow: visible !important;
                width: 100% !important;
            }

            body.print-mode-active #reports-section {
                display: block !important;
                width: 100% !important; 
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                margin: 0 !important; 
                padding: 0; /* Let Tailwind p-8 apply or set specific print padding */
                box-sizing: border-box;
            }
            
            body.print-mode-active, html.print-mode-active {
                background-color: #fff !important;
                overflow: visible !important;
                height: auto !important;
                margin:0; padding:0;
            }

            /* Hide URL in print header/footer for some browsers */
            @page {
                size: A4 portrait; /* Or 'auto' if preferred */
                margin: 15mm; 
            }
            body {
                -webkit-print-color-adjust: exact !important; /* For Chrome/Safari */
                color-adjust: exact !important;               /* Standard */
            }
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px; /* Changed from bottom */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for centering */
            z-index: 1050; /* أعلى من النوافذ المنبثقة الأخرى */
            display: flex;
            flex-direction: column; /* New toasts appear below old ones */
            gap: 10px;
            align-items: center; /* Center toasts within the container */
        }

        .toast {
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-family: 'Cairo', 'Tajawal', sans-serif; /* Changed font */
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0; /* يبدأ خارج الشاشة من اليسار */
            transform: translateY(-150%); /* Start above the screen */
            animation: toast-slide-in-top 0.4s ease-out forwards, toast-fade-out-top 0.4s ease-in var(--toast-fade-delay, 3.5s) forwards;
            min-width: 250px; /* حد أدنى للعرض */
            max-width: 350px;
        }

        .toast.toast-success {
            background-color: #28a745; /* أخضر */
            border-right: 4px solid #1e7e34;
        }

        .toast.toast-warning {
            background-color: #ffc107; /* أصفر/برتقالي */
            color: #212529; /* نص أغمق للخلفية الصفراء */
            border-right: 4px solid #d39e00;
        }

        .toast.toast-error {
            background-color: #dc3545; /* أحمر */
            border-right: 4px solid #b02a37;
        }

        .toast.toast-info {
            background-color: #17a2b8; /* أزرق */
            border-right: 4px solid #117a8b;
        }

        @keyframes toast-slide-in-top {
            to {
                opacity: 1;
                transform: translateY(0); /* Slide in from top */
            }
        }

        @keyframes toast-fade-out-top {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-150%); /* Slide out to top */
            }
        }
    </style>
</head>
<body class="rtl">
    <!-- Top Bar (Barre Supérieure) -->
    <header class="fixed top-0 left-0 right-0 z-40 bg-white shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center space-x-4 rtl:space-x-reverse">
            <span class="text-blue-600 font-extrabold text-2xl">Quantix-Youssef</span>
        </div>
        <div class="flex items-center flex-grow mx-4 max-w-md">
            <input
                type="text"
                id="search-input"
                placeholder="بحث..."
                class="w-full p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800 rtl:rounded-l-lg rtl:rounded-r-none"
            />
            <button class="bg-blue-600 text-white p-3 rounded-l-lg hover:bg-blue-700 transition duration-200 rtl:rounded-l-lg rtl:rounded-r-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
        </div>
        <div class="flex items-center space-x-4 rtl:space-x-reverse">
            <button
                id="cart-button"
                class="relative bg-blue-500 text-white px-6 py-2 rounded-lg flex items-center space-x-2 rtl:space-x-reverse hover:bg-blue-600 transition duration-200 shadow-md"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg>
                <span>السلة</span>
                <span id="cart-count" class="absolute -top-2 -left-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center rtl:-right-2 rtl:-left-auto">0</span>
            </button>
            <button
                id="undo-last-transaction-button"
                class="relative bg-yellow-500 text-white px-4 py-2 rounded-lg flex items-center space-x-2 rtl:space-x-reverse hover:bg-yellow-600 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                title="التراجع عن آخر عملية بيع/فاتورة"
                disabled
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6-6m-6 6l6 6"></path></svg>
                <span>تراجع</span>
            </button>
            <button
                id="reset-cart-stock-button"
                class="relative bg-orange-500 text-white px-4 py-2 rounded-lg flex items-center space-x-2 rtl:space-x-reverse hover:bg-orange-600 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                title="إفراغ السلة وإرجاع الكميات للمخزون"
                disabled
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3l-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3l-3 3"></path></svg>
                <span>تفريغ السلة</span>
            </button>
            <button
                id="notifications-button"
                class="relative p-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 shadow-sm"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                <span id="notification-dot" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-3 w-3 flex items-center justify-center hidden"></span>
            </button>
            <button
                id="settings-button"
                class="p-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 shadow-sm"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.312 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            <button id="store-profile-button" class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-800 font-semibold text-lg overflow-hidden cursor-pointer shadow-sm" title="تعديل اسم المحل">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Side Bar (Barre Latérale / Sidebar) -->
    <aside class="fixed top-20 right-0 h-[calc(100vh-80px)] w-60 bg-[#4B1F4D] text-white shadow-lg p-4 flex flex-col rounded-tr-lg rounded-br-lg z-30">
        <div class="flex items-center space-x-3 rtl:space-x-reverse mb-8">
            <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center overflow-hidden">
                <img src="img.jpeg" alt="Icon" class="w-full h-full object-cover" id="sidebar-profile-image" />
            </div>

            <span class="font-semibold text-xl">القائمة</span>
        </div>
        <nav class="space-y-4">
            <button id="nav-inventory" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 bg-blue-600 text-white shadow-md" data-tab="inventory">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="font-medium text-lg">المخزون</span>
            </button>
            <button id="nav-low-stock" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="low-stock">
                <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <span class="font-medium text-lg">مخزون منخفض</span>
            </button>
            <button id="nav-credit" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="credit">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                <span class="font-medium text-lg">الكريدي</span>
            </button>
                <button id="nav-debts" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="debts">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="font-medium text-lg">الديون</span>
            </button>
            <button id="nav-invoices" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="invoices">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="font-medium text-lg">الفواتير</span>
            </button>
            <button id="nav-suppliers" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="suppliers">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span class="font-medium text-lg">الموردون</span>
            </button>
            <button id="nav-reports" class="nav-item flex items-center space-x-4 rtl:space-x-reverse w-full text-right p-3 rounded-lg transition duration-200 text-gray-300 hover:bg-gray-700" data-tab="reports">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span class="font-medium text-lg">التقارير</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content Area (Zone de Contenu Principal) -->
    <main class="main-content-area relative">
            
        <div id="inventory-section" class="section-content active p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">إدارة المخزون</h1>
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div class="flex gap-3">
                    <select id="inventory-sort-select" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="name-asc">الاسم (أ - ي)</option>
                        <option value="name-desc">الاسم (ي - أ)</option>
                        <option value="price-asc">السعر (الأقل أولاً)</option>
                        <option value="price-desc">السعر (الأعلى أولاً)</option>
                        <option value="quantity-asc">الكمية (الأقل أولاً)</option>
                        <option value="quantity-desc">الكمية (الأكثر أولاً)</option>
                    </select>
                    <select id="inventory-category-filter" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                       <option value="all">جميع الفئات</option>
                        <!-- سيتم ملء الخيارات بواسطة JavaScript -->
                    </select>
                    <button id="print-products-button" class="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                        <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        طباعة سجل المنتجات
                    </button>
                </div>
                <button id="add-product-button" class="flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    إضافة منتج جديد
                </button>
            </div>
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Product cards will be rendered here by JavaScript -->
            </div>
            <p id="no-products-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد منتجات حتى الآن...</p>
            <p id="no-search-results-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد منتجات مطابقة للبحث.</p>
        </div>

        <!-- Low Stock Section (NEW) -->
        <div id="low-stock-section" class="section-content p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">المنتجات ذات المخزون المنخفض</h1>
            <div id="low-stock-products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Low stock product cards will be rendered here by JavaScript -->
            </div>
            <p id="no-low-stock-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد منتجات ذات مخزون منخفض حالياً.</p>
        </div>


        <!-- Credit Section -->
        <div id="credit-section" class="section-content p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">إدارة الكريدي</h1>
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div class="flex gap-3">
                    <select id="credit-status-filter" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">كل الحالات</option>
                        <option value="unpaid">غير مدفوع</option>
                        <option value="paid">مدفوع</option>
                    </select>
                    <select id="credit-sort-select" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="date-desc">التاريخ (الأحدث أولاً)</option>
                        <option value="date-asc">التاريخ (الأقدم أولاً)</option>
                        <option value="name-asc">الاسم (أ - ي)</option>
                        <option value="name-desc">الاسم (ي - أ)</option>
                    </select>
                    <button id="print-credits-button" class="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                        <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        طباعة سجل الكريديات
                    </button>
                </div>
                <button id="add-credit-button" class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    إضافة كريدي جديد
                </button>
            </div>
            <div id="credits-table-container" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- Credits table will be rendered here by JavaScript -->
            </div>
            <p id="no-credits-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد سجلات كريدي.</p>
        </div>

        <!-- Invoices Section -->
        <div id="invoices-section" class="section-content p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">الفواتير</h1>
            <div class="flex justify-end items-center mb-6">
                <button id="print-invoices-list-button" class="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    طباعة قائمة الفواتير
                </button>
            </div>
            <div id="invoices-table-container" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- Invoices table will be rendered here by JavaScript -->
            </div>
            <p id="no-invoices-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد فواتير حتى الآن.</p>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section-content p-8">
            <!-- Content will be loaded by ReportsManager -->
        </div>

        <!-- Suppliers Section (NEW) -->
        <div id="suppliers-section" class="section-content p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">إدارة الموردين</h1>
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div class="flex gap-3">
                    <select id="suppliers-sort-select" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="name-asc">الاسم (أ - ي)</option>
                        <option value="name-desc">الاسم (ي - أ)</option>
                        <option value="company-asc">الشركة (أ - ي)</option>
                        <option value="company-desc">الشركة (ي - أ)</option>
                    </select>
                </div>
                <button id="print-suppliers-button" class="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    طباعة قائمة الموردين
                </button>
                    <button id="add-supplier-button" class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    إضافة مورد جديد
                </button>
            </div>
            <div id="suppliers-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Supplier cards will be rendered here by JavaScript -->
            </div>
            <p id="no-suppliers-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا يوجد موردون حتى الآن...</p>
        </div>

        <!-- Debts Section -->

        <!-- Debts Section (NEW) -->
        <div id="debts-section" class="section-content p-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8">إدارة الديون</h1>
            <p class="text-lg text-gray-600 mb-6">
                هنا يمكنك تتبع وإدارة جميع الديون المستحقة عليك للموردين أو جهات أخرى.
                تعرف بالضبط شحال خاصك تخلّص، لمّن، ووقتاش.
            </p>
            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div class="flex gap-3">
                    <select id="debt-status-filter" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">كل الحالات</option>
                        <option value="pending">باقي</option>
                        <option value="paid">تم الأداء</option>
                    </select>
                    <select id="debt-sort-select" class="p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="dueDate-asc">تاريخ الاستحقاق (الأقرب أولاً)</option>
                        <option value="dueDate-desc">تاريخ الاستحقاق (الأبعد أولاً)</option>
                        <option value="creditorName-asc">اسم الدائن (أ - ي)</option>
                        <option value="creditorName-desc">اسم الدائن (ي - أ)</option>
                        <option value="amount-desc">المبلغ (الأعلى أولاً)</option>
                        <option value="amount-asc">المبلغ (الأقل أولاً)</option>
                    </select>
                    <button id="print-debts-button" class="flex items-center px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md">
                        <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        طباعة سجل الديون
                    </button>
                </div>
                <button id="add-debt-button" class="flex items-center px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 shadow-md">
                    <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    إضافة دين جديد
                </button>
            </div>
            <div id="debts-table-container" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- Debts table will be rendered here by JavaScript -->
            </div>
            <p id="no-debts-message" class="text-center text-gray-600 text-xl mt-12 hidden">لا توجد ديون مسجلة حالياً.</p>
        </div>
    </main>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- Generic Modal Structure -->
        <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
            <div id="generic-modal-main-panel" class="bg-white rounded-xl shadow-lg w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-200">
                    <h2 id="generic-modal-title" class="text-xl font-bold text-gray-800"></h2>
                    <button id="generic-modal-close" class="text-gray-500 hover:text-gray-700 text-2xl font-semibold">
                        &times;
                    </button>
                </div>
                <div id="generic-modal-content" class="p-4 overflow-y-auto flex-grow">
                    <!-- Modal specific content will be injected here -->
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-sm flex flex-col">
                <div class="flex justify-between items-center p-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">تأكيد</h2>
                    <button id="confirm-modal-close" class="text-gray-500 hover:text-gray-700 text-2xl font-semibold">
                        &times;
                    </button>
                </div>
                <div class="p-4 flex-grow">
                    <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-modal-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="confirm-modal-confirm" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200">
                            تأكيد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Hidden file input for data restoration -->
    <input type="file" id="restore-file-input" class="hidden" accept=".json">

    <script type="module">
        // Import the functions you need from the SDKs you need
        // Using Firebase v10.7.1 from CDN as an example
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyD6YMn-gHZ6j-5SRTCz3qt4eNuw5__W2Pk",
            authDomain: "quantix-anas.firebaseapp.com",
            projectId: "quantix-anas",
            storageBucket: "quantix-anas.firebasestorage.app",
            messagingSenderId: "146602334877",
            appId: "1:146602334877:web:4f00bd17b9b97730489274",
            measurementId: "G-EGS2MX8QNP"
        };

        // Initialize Firebase
        const appFirebaseClient = initializeApp(firebaseConfig); // Renamed to avoid conflict with Electron's 'app'
        const analytics = getAnalytics(appFirebaseClient);
        console.log('Firebase Client SDK initialized in renderer process (index.html)');
    </script>
    <script>
        // Global application state
        let appData = {
            products: [],
            credits: [],
            invoices: [],
            suppliers: [], // NEW
            directSales: [], // NEW: To store direct sales transactions
            debts: [], // NEW
            cartItems: [], // { productId, quantity }
            notifications: [], // { message, date, read }
            dailySales: { // New structure for daily hourly sales
                date: new Date().toISOString().slice(0, 10), //YYYY-MM-DD
                hourlySales: Array(24).fill(0) // 0-23 hours
            },
            monthlySalesData: {}, // { 'YYYY-MM': total_sales }
            weeklySalesData: {}, // { 'YYYY-MM-DD': total_sales } for last 7 days
            storeName: '', // NEW: Add store name
            storeLogo: null, // NEW: Add store logo (Data URL)
            activeTab: 'inventory',
            searchTerm: '',
            lastTransaction: null, // { type: 'sale'/'invoice', soldItems: [], total: 0, invoiceId: null, customerName: null, transactionDate: ISOString }
            productToEditId: null, // Moved lastTransaction up for grouping
            creditToEditId: null,
            supplierToEditId: null, // NEW
            debtToEditId: null, // NEW
            currentConfirmationCallback: null
        };

        // --- DOM Elements Cache ---
        const searchInput = document.getElementById('search-input');
        const cartButton = document.getElementById('cart-button');
        const cartCountSpan = document.getElementById('cart-count');
        const notificationsButton = document.getElementById('notifications-button');
        const notificationDot = document.getElementById('notification-dot'); // NEW
        const settingsButton = document.getElementById('settings-button');
        const undoLastTransactionButton = document.getElementById('undo-last-transaction-button');
        const resetCartStockButton = document.getElementById('reset-cart-stock-button');
        const storeProfileButton = document.getElementById('store-profile-button'); // Renamed userAvatar to storeProfileButton for clarity

        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section-content');

        // Inventory Section Elements
        const productsGrid = document.getElementById('products-grid');
        const inventorySortSelect = document.getElementById('inventory-sort-select');
        const addProductButton = document.getElementById('add-product-button');
        const inventoryCategoryFilter = document.getElementById('inventory-category-filter');
        const printProductsButton = document.getElementById('print-products-button');
        const noProductsMessage = document.getElementById('no-products-message');
        const noSearchResultsMessage = document.getElementById('no-search-results-message');

        // Low Stock Section Elements
        const lowStockProductsGrid = document.getElementById('low-stock-products-grid');
        const noLowStockMessage = document.getElementById('no-low-stock-message');

        // Credit Section Elements
        const creditsTableContainer = document.getElementById('credits-table-container');
        const creditStatusFilter = document.getElementById('credit-status-filter');
        const creditSortSelect = document.getElementById('credit-sort-select');
        const addCreditButton = document.getElementById('add-credit-button');
        const printCreditsButton = document.getElementById('print-credits-button');
        const noCreditsMessage = document.getElementById('no-credits-message');

        // Invoices Section Elements
        const invoicesTableContainer = document.getElementById('invoices-table-container');
        const printInvoicesListButton = document.getElementById('print-invoices-list-button');
        const noInvoicesMessage = document.getElementById('no-invoices-message');

        // Reports Section Elements
        // const totalInventoryQuantitySpan = document.getElementById('total-inventory-quantity'); // Now handled by ReportsManager
        // const lowStockCountSpan = document.getElementById('low-stock-count'); // Now handled by ReportsManager
        // const lowStockListUl = document.getElementById('low-stock-list'); // Now handled by ReportsManager
        // const bestSellingProductsListUl = document.getElementById('best-selling-products-list'); // Now handled by ReportsManager
        const monthlySalesTotalSpan = document.getElementById('monthly-sales-total');
        const monthlyOrdersCountSpan = document.getElementById('monthly-orders-count');
        const backupDataButton = document.getElementById('backup-data-button');
        const restoreDataButton = document.getElementById('restore-data-button');
        const restoreFileInput = document.getElementById('restore-file-input');

        // Suppliers Section Elements (NEW)
        const suppliersGrid = document.getElementById('suppliers-grid');
        const suppliersSortSelect = document.getElementById('suppliers-sort-select');
        const addSupplierButton = document.getElementById('add-supplier-button');
        const noSuppliersMessage = document.getElementById('no-suppliers-message');
        const printSuppliersButton = document.getElementById('print-suppliers-button'); // NEW


        // Debts Section Elements (NEW)
        const debtsTableContainer = document.getElementById('debts-table-container');
        const debtStatusFilter = document.getElementById('debt-status-filter');
        const debtSortSelect = document.getElementById('debt-sort-select');
        const addDebtButton = document.getElementById('add-debt-button');
        const printDebtsButton = document.getElementById('print-debts-button');
        const noDebtsMessage = document.getElementById('no-debts-message');



        // Chart Canvases
        // const monthlySalesChartCanvas = document.getElementById('monthly-sales-chart'); // Now handled by ReportsManager
        // const weeklySalesChartCanvas = document.getElementById('weekly-sales-chart'); // Now handled by ReportsManager
        // const dailySalesChartCanvas = document.getElementById('daily-sales-chart'); // Now handled by ReportsManager
        // const profitAnalysisChartCanvas = document.getElementById('profit-analysis-chart'); // Now handled by ReportsManager

        // Modal Elements
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalContent = document.getElementById('generic-modal-content');
        const genericModalCloseButton = document.getElementById('generic-modal-close');

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalCancelButton = document.getElementById('confirm-modal-cancel');
        const confirmModalConfirmButton = document.getElementById('confirm-modal-confirm');
        const confirmModalCloseButton = document.getElementById('confirm-modal-close');

        // --- Global variables for session-specific UI changes ---
        let currentStoreLogoSrc = null; // Holds the Data URL for the session logo
        const originalHeaderProfileButtonSVG = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`;
        const defaultSidebarProfileImageSrc = 'img.jpeg'; // Default sidebar image
        // --- Toast Notification System ---
        let reportsManagerInstance = null; // Holder for ReportsManager

        // ===== REPORTS MANAGEMENT (Integrated from reports.js) =====
        class ReportsManager {
            constructor() {
                this.currentPeriod = 'month'; // Default period
                this.charts = {};
                // No init() call here, will be called by loadReports or similar
            }

            init() { // Called by loadReports after HTML injection
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Event listeners are attached to `document` so they persist.
                // Ensure this is only called once or manage listeners carefully.
                // For simplicity, assuming it's okay to re-attach if loadReports is called multiple times,
                // but ideally, this should be managed to avoid duplicate listeners.
                // A flag could prevent re-attachment.
                if (this.eventListenersAttached) return;

                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('period-btn')) {
                        this.handlePeriodChange(e.target);
                    }
                    
                    if (e.target.classList.contains('export-btn')) {
                        this.exportReport(e.target.dataset.type);
                    }
                    
                    if (e.target.classList.contains('print-btn')) {
                        this.printReport();
                    }
                    // New: Handle clicks for table detail modals
                    if (e.target.closest('.view-table-details-btn')) {
                        this.showTableDetailsInModal(e.target.closest('.view-table-details-btn').dataset.tableType);
                    }
                    // New: Handle click on low stock summary card
                    const lowStockCard = e.target.closest('#low-stock-summary-card');
                    if (lowStockCard) {
                        // Simulate click on the 'nav-low-stock' button
                        const lowStockNavLink = document.getElementById('nav-low-stock');
                        if (lowStockNavLink) lowStockNavLink.click();
                    }
                });
                this.eventListenersAttached = true;
            }

            loadReports() {
                console.log("[DEBUG] ReportsManager.loadReports() called");
                const reportsPage = document.getElementById('reports-section');
                if (!reportsPage) {
                    console.error("[DEBUG] ReportsManager: #reports-section NOT FOUND in loadReports method.");
                    return;
                }
                console.log("[DEBUG] ReportsManager: #reports-section found in loadReports.");

                const htmlContent = this.getReportsHTML();
                console.log("[DEBUG] ReportsManager: Generated HTML content length:", htmlContent.length);
                if (htmlContent.length < 100) { // Arbitrary short length to suspect empty HTML
                    console.warn("[DEBUG] ReportsManager: getReportsHTML() returned very short content. Is it correct?");
                }

                try {
                    reportsPage.innerHTML = htmlContent;
                    console.log("[DEBUG] ReportsManager: innerHTML has been set. First 100 chars:", reportsPage.innerHTML.substring(0,100));
                } catch (e) {
                    console.error("[DEBUG] ReportsManager: Error setting innerHTML for reportsPage:", e);
                    return; // Stop if HTML cannot be injected
                }

                try {
                    this.init(); // Setup event listeners after HTML is in place
                    console.log("[DEBUG] ReportsManager: this.init() called.");
                } catch (e) {
                    console.error("[DEBUG] ReportsManager: Error in this.init():", e);
                }
                                
                // Delay chart initialization slightly to ensure DOM is fully ready
                setTimeout(() => {
                    this.updateReportData(); // This will fetch data and update cards, tables
                    this.initializeCharts(); // This will create new charts
                }, 100);
            }

            getReportsHTML() {
                // HTML structure from reports.js, with adaptations
                return `
                    <div class="page-header flex justify-between items-center mb-8" data-aos="fade-down">
                        <div>
                            <h2 class="page-title text-3xl font-bold text-gray-800">التقارير والإحصائيات</h2>
                            <p class="page-description text-gray-600 mt-1">تقارير مفصلة عن الأداء والمخزون</p>
                        </div>
                        <div class="header-actions flex space-x-3 rtl:space-x-reverse">
                            <button class="btn btn-outline print-btn flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                                <i class="fas fa-print mr-2"></i> طباعة التقرير
                            </button>
                            <button class="btn btn-primary export-btn flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 print-btn">
                                <i class="fas fa-file-pdf mr-2"></i> تصدير PDF
                            </button>
                        </div>
                    </div>

                    <div class="period-selector my-6 p-4 bg-gray-50 rounded-md shadow" data-aos="fade-up" data-aos-delay="100">
                        <div class="period-buttons flex space-x-2 rtl:space-x-reverse mb-2">
                            <button class="period-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 transition-colors duration-150" data-period="week">أسبوع</button>
                            <button class="period-btn px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white shadow-md focus:outline-none focus:ring-2 focus:ring-blue-700 focus:ring-opacity-75 transition-colors duration-150 active" data-period="month">شهر</button>
                            <button class="period-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 transition-colors duration-150" data-period="quarter">ربع سنة</button>
                            <button class="period-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50 transition-colors duration-150" data-period="year">سنة</button>
                        </div>
                        <div class="period-info text-sm text-gray-700">
                            <span id="current-period-text">التقرير الشهري</span> - 
                            <span id="period-date-range"></span>
                        </div>
                    </div>

                    <div class="report-summary grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" data-aos="fade-up" data-aos-delay="200">
                        <!-- بطاقة إجمالي الإيرادات -->
                        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse hover:shadow-xl transition-shadow duration-300">
                            <div class="flex-shrink-0 h-14 w-14 rounded-full flex items-center justify-center bg-blue-100 text-blue-600">
                                <i class="fas fa-chart-line text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">إجمالي الإيرادات</h3>
                                <p class="text-2xl font-semibold text-gray-900" id="total-revenue">0 د.م.</p>
                            </div>
                        </div>

                        <!-- بطاقة إجمالي المنتجات -->
                        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse hover:shadow-xl transition-shadow duration-300">
                            <div class="flex-shrink-0 h-14 w-14 rounded-full flex items-center justify-center bg-green-100 text-green-600">
                                <i class="fas fa-box-open text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">إجمالي المنتجات</h3>
                                <p class="text-2xl font-semibold text-gray-900" id="total-products">0</p>
                            </div>
                        </div>

                        <!-- بطاقة عدد المخزون المنخفض -->
                        <div id="low-stock-summary-card" class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse hover:shadow-xl transition-shadow duration-300 cursor-pointer">
                            <div class="flex-shrink-0 h-14 w-14 rounded-full flex items-center justify-center bg-orange-100 text-orange-600">
                                <i class="fas fa-exclamation-triangle text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">عدد المخزون المنخفض</h3>
                                <p class="text-2xl font-semibold text-gray-900" id="low-stock-summary-count">0</p>
                            </div>
                        </div>

                        <!-- بطاقة الربح الصافي من المنتوجاتك -->
                        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse hover:shadow-xl transition-shadow duration-300">
                            <div class="flex-shrink-0 h-14 w-14 rounded-full flex items-center justify-center bg-teal-100 text-teal-600">
                                <i class="fas fa-dollar-sign text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">الربح الصافي من المنتوجاتك</h3>
                                <p class="text-2xl font-semibold text-gray-900" id="average-net-profit-value">0 د.م.</p>
                            </div>
                        </div>
                    </div>

                    <div class="reports-charts grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" data-aos="fade-up" data-aos-delay="300">
                        <div class="chart-container bg-white p-5 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-3">تطور الإيرادات</h3>
                            <div class="chart-wrapper h-64"><canvas id="revenue-trend-chart"></canvas></div>
                        </div>
                        <div class="chart-container bg-white p-5 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-3">توزيع فئات المنتجات</h3>
                            <div class="chart-wrapper h-64"><canvas id="product-category-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="report-tables grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" data-aos="fade-up" data-aos-delay="400">
                        <div class="table-container bg-white p-4 rounded-md shadow">
                            <div class="table-header flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-gray-800">أعلى المنتجات سعراً</h3>
                                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                    <span class="table-count text-sm text-gray-500" id="top-products-count">0 منتج</span>
                                    <button class="view-table-details-btn text-blue-600 hover:text-blue-800 p-1 rounded-md hover:bg-blue-100 transition-colors duration-200" data-table-type="top-products" title="عرض التفاصيل">
                                        <i class="fas fa-external-link-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-wrapper overflow-x-auto rounded-lg border border-gray-200">
                                <table class="report-table w-full text-sm" id="top-products-table">
                                    <thead class="bg-gray-100"><tr class="text-right"><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">المنتج</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">الفئة</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">سعر البيع</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">الكمية</th></tr></thead>
                                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="table-container bg-white p-4 rounded-md shadow">
                            <div class="table-header flex justify-between items-center mb-3">
                                <h3 class="text-xl font-semibold text-gray-800">المعاملات الأخيرة</h3>
                                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                    <span class="table-count text-sm text-gray-500" id="recent-transactions-count">0 معاملة</span>
                                    <button class="view-table-details-btn text-blue-600 hover:text-blue-800 p-1 rounded-md hover:bg-blue-100 transition-colors duration-200" data-table-type="recent-transactions" title="عرض التفاصيل">
                                        <i class="fas fa-external-link-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-wrapper overflow-x-auto rounded-lg border border-gray-200">
                                <table class="report-table w-full text-sm" id="recent-transactions-table">
                                    <thead class="bg-gray-100"><tr class="text-right"><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">التاريخ</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">الزبون</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">النوع</th><th class="p-3 font-semibold text-gray-600 uppercase tracking-wider">المبلغ</th></tr></thead>
                                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                     <div class="financial-summary bg-white p-6 rounded-xl shadow-lg" data-aos="fade-up" data-aos-delay="500">
                        <div class="summary-header mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">الملخص المالي</h3>
                            <span id="financial-period" class="text-sm text-gray-600"></span>
                        </div>
                        <div class="financial-grid grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-base">
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <label class="font-semibold text-gray-700">إجمالي الإيرادات:</label> 
                                <span class="amount positive text-green-600 font-bold text-lg" id="summary-total-revenue">0 د.م.</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <label class="font-semibold text-gray-700">المدفوعات المعلقة (كريدي):</label> 
                                <span class="amount pending text-yellow-600 font-bold text-lg" id="summary-pending-payments">0 د.م.</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200 md:border-b-0">
                                <label class="font-semibold text-gray-700">متوسط قيمة الفاتورة:</label> 
                                <span class="amount text-blue-600 font-bold text-lg" id="summary-average-invoice-value">0 د.م.</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <label class="font-semibold text-gray-700">عدد الفواتير:</label> 
                                <span class="count text-blue-600 font-bold text-lg" id="summary-invoices-count">0</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            updateReportData() {
                const products = appData.products || [];
                const invoices = appData.invoices || [];
                const directSales = appData.directSales || []; // NEW: Get direct sales
                const credits = appData.credits || [];

                const clientNamesFromInvoices = invoices.map(inv => inv.customerName);
                const clientNamesFromCredits = credits.map(cr => cr.customer);
                const uniqueClientNames = [...new Set([...clientNamesFromInvoices, ...clientNamesFromCredits].filter(name => name && name.trim() !== ''))];
                const clients = uniqueClientNames.map((name, index) => ({ id: `client-${index}`, name }));

                // Combine invoices and direct sales for "allTransactions" list
                // to be used by updateRecentTransactionsTable
                const salesTransactions = directSales.map(sale => ({
                    id: sale.id,
                    amount: sale.total,
                    status: 'paid', // Direct sales are considered paid
                    createdAt: new Date(sale.date),
                    paidDate: new Date(sale.date),
                    clientId: null, // Direct sales might not have a client ID in the same way invoices do
                    customerName: 'بيع مباشر', // Or a generic name, or if you store customer name for direct sales, use it
                    type: 'بيع مباشر',
                    items: sale.items.map(item => `${item.name} (x${item.quantity})`).join(', ')
                }));

                let allTransactions = [];
                invoices.forEach(inv => {
                    allTransactions.push({
                        id: inv.id,
                        amount: inv.total,
                        status: 'paid',
                        createdAt: new Date(inv.date),
                        paidDate: new Date(inv.date),
                        clientId: clients.find(c => c.name === inv.customerName)?.id,
                        customerName: inv.customerName,
                        type: 'فاتورة',
                        items: inv.items.map(item => `${item.name} (x${item.quantity})`).join(', ')
                    });
                });
                credits.forEach(cr => {
                     allTransactions.push({ // Keep credits for pending/overdue, but don't double count for revenue if they become invoices
                        id: cr.id,
                        amount: cr.amount,
                        status: cr.status, // 'paid' or 'unpaid'
                        createdAt: new Date(cr.date),
                        dueDate: new Date(cr.date), // Assuming credit date is due date for simplicity
                        clientId: clients.find(c => c.name === cr.customer)?.id,
                        customerName: cr.customer,
                        type: 'كريدي',
                        items: cr.product
                    });
                });

                // Add sales transactions to allTransactions and sort
                allTransactions = allTransactions.concat(salesTransactions).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                this.updateSummaryCards(products, clients, allTransactions, invoices, directSales); // NEW: Pass directSales
                this.updateTopProductsTable(products); // Changed from TopProperties
                this.updateRecentTransactionsTable(allTransactions, clients); // Removed products from here
                this.updateFinancialSummary(allTransactions, invoices, credits, directSales); // NEW: Pass directSales
                this.updatePeriodInfo();
            }
            updateSummaryCards(products, clients, allTransactions, invoices, directSales) { // NEW: Added directSales parameter
                // Calculate total revenue from invoices
                const totalRevenueFromInvoices = invoices.reduce((sum, inv) => sum + inv.total, 0);
                // Calculate total revenue from direct sales
                const totalRevenueFromDirectSales = directSales.reduce((sum, sale) => sum + sale.total, 0);
                // Combined total revenue for the summary card
                const combinedTotalRevenue = totalRevenueFromInvoices + totalRevenueFromDirectSales;
                document.getElementById('total-revenue').textContent = formatCurrency(combinedTotalRevenue);
                
                // Update low stock summary count
                const lowStockThreshold = 3;
                const lowStockItemsCount = products.filter(p => p.quantity <= lowStockThreshold).length;
                const lowStockSummaryCountEl = document.getElementById('low-stock-summary-count');
                if (lowStockSummaryCountEl) lowStockSummaryCountEl.textContent = lowStockItemsCount;

                document.getElementById('total-products').textContent = products.length;
                
                // حساب الربح الصافي من المنتجات المباعة فقط
                let totalNetProfitFromTransactions = 0;

                // حساب الربح من الفواتير
                invoices.forEach(invoice => {
                    if (!invoice.items) return; // Safety check
                    invoice.items.forEach(item => {
                        const productDetails = products.find(p => p.id === item.productId);
                        if (productDetails) {
                            const costPrice = productDetails.costPrice || 0;
                            const sellingPrice = item.price; // سعر البيع وقت إنشاء الفاتورة
                            totalNetProfitFromTransactions += (sellingPrice - costPrice) * item.quantity;
                        }
                    });
                });

                // NEW: حساب الربح من المبيعات المباشرة
                directSales.forEach(sale => {
                    if (!sale.items) return; // Safety check - Changed from sale.soldItems to sale.items
                    sale.items.forEach(item => { // Changed from sale.soldItems to sale.items
                        const productDetails = products.find(p => p.id === item.productId);
                        if (productDetails) {
                            const costPrice = productDetails.costPrice || 0;
                            const sellingPrice = item.price; // سعر البيع وقت البيع المباشر
                            totalNetProfitFromTransactions += (sellingPrice - costPrice) * item.quantity;
                        }
                    });
                });

                document.getElementById('average-net-profit-value').textContent = formatCurrency(totalNetProfitFromTransactions);
            }

            updateTopProductsTable(products) {
                const tableBody = document.querySelector('#top-products-table tbody');
                if (!tableBody) return;
                
                const sortedProducts = [...products].sort((a, b) => b.price - a.price).slice(0, 5); // Top 5 for example
                
                document.getElementById('top-products-count').textContent = sortedProducts.length + ' منتج';
                
                tableBody.innerHTML = sortedProducts.map(p => `
                    <tr class="hover:bg-gray-50 text-right">
                        <td class="p-3 text-gray-800">${p.name}</td>
                        <td class="p-3 text-gray-600">${p.category}</td>
                        <td class="p-3 text-gray-600">${formatCurrency(p.price)}</td>
                        <td class="p-3 text-gray-600">${p.quantity}</td>
                    </tr>
                `).join('');
            }

            updateRecentTransactionsTable(allTransactions, clients) {
                const tableBody = document.querySelector('#recent-transactions-table tbody');
                if (!tableBody) return;
                
                const recentTransactions = allTransactions.slice(0, 5); // Already sorted by date desc
                
                document.getElementById('recent-transactions-count').textContent = recentTransactions.length + ' معاملة';
                
                tableBody.innerHTML = recentTransactions.map(transaction => {
                    const client = clients.find(c => c.id === transaction.clientId);
                    return `
                        <tr class="hover:bg-gray-50 text-right">
                            <td class="p-3 text-gray-600">${formatDateOnly(transaction.createdAt)}</td>
                            <td class="p-3 text-gray-800">${transaction.type === 'بيع مباشر' ? 'بيع مباشر' : (client ? client.name : (transaction.customerName || 'غير محدد'))}</td>
                            <td class="p-3 text-gray-600">${transaction.type}</td>
                            <td class="p-3 text-gray-600">${formatCurrency(transaction.amount)}</td>
                        </tr>
                    `;
                }).join('');
            }

            updateFinancialSummary(allTransactions, invoices, credits, directSales) { // NEW: Added directSales parameter
                const totalRevenueFromInvoices = invoices.reduce((sum, inv) => sum + inv.total, 0);
                const totalRevenueFromDirectSales = directSales.reduce((sum, sale) => sum + sale.total, 0);
                const combinedTotalRevenueForSummary = totalRevenueFromInvoices + totalRevenueFromDirectSales;

                document.getElementById('summary-total-revenue').textContent = formatCurrency(combinedTotalRevenueForSummary);

                const pendingAmountFromCredits = credits.filter(cr => cr.status === 'unpaid').reduce((sum, cr) => sum + cr.amount, 0);
                document.getElementById('summary-pending-payments').textContent = formatCurrency(pendingAmountFromCredits);

                const averageInvoiceValue = invoices.length > 0 ? totalRevenueFromInvoices / invoices.length : 0;
                document.getElementById('summary-average-invoice-value').textContent = formatCurrency(averageInvoiceValue);
                document.getElementById('summary-invoices-count').textContent = invoices.length;
                
                document.getElementById('financial-period').textContent = this.getPeriodText();
            }

            updatePeriodInfo() {
                const periodText = this.getPeriodText();
                const dateRange = this.getDateRange();
                
                const currentPeriodTextEl = document.getElementById('current-period-text');
                if (currentPeriodTextEl) currentPeriodTextEl.textContent = periodText;
                const periodDateRangeEl = document.getElementById('period-date-range');
                if (periodDateRangeEl) periodDateRangeEl.textContent = dateRange;
            }

            initializeCharts() {
                this.initRevenueTrendChart();
                this.initProductCategoryChart();
            }

            initRevenueTrendChart() {
                const ctx = document.getElementById('revenue-trend-chart');
                if (!ctx) return;
                
                const paidInvoices = (appData.invoices || []).filter(inv => inv.date); // Assuming all invoices are 'paid'
                const chartData = this.getRevenueTrendData(paidInvoices);
                
                if (this.charts.revenueTrend) this.charts.revenueTrend.destroy();
                this.charts.revenueTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'الإيرادات',
                            data: chartData.data,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            initProductCategoryChart() {
                const ctx = document.getElementById('product-category-chart');
                if (!ctx) return;
                
                const products = appData.products || [];
                const categoryData = this.getProductCategoryData(products);
                
                const backgroundColors = ['#3498db', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22'];
                
                if (this.charts.productCategory) this.charts.productCategory.destroy();
                this.charts.productCategory = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categoryData.labels,
                        datasets: [{
                            data: categoryData.data,
                            backgroundColor: categoryData.labels.map((_, i) => backgroundColors[i % backgroundColors.length])
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            getRevenueTrendData(paidInvoices) {
                const labels = [];
                const data = [];
                const periods = this.getPeriods(); // getPeriods needs to be adapted for currentPeriod
                
                periods.forEach(period => {
                    labels.push(period.label);
                    const periodRevenue = paidInvoices
                        .filter(inv => {
                            const invDate = new Date(inv.date);
                            return invDate >= period.start && invDate <= period.end;
                        })
                        .reduce((sum, inv) => sum + inv.total, 0);
                    data.push(periodRevenue);
                });
                return { labels, data };
            }

            getProductCategoryData(products) {
                const categoryCounts = {};
                products.forEach(product => {
                    categoryCounts[product.category] = (categoryCounts[product.category] || 0) + 1;
                });
                return {
                    labels: Object.keys(categoryCounts),
                    data: Object.values(categoryCounts)
                };
            }

            getPeriods() {
                const now = new Date();
                const periods = [];
                let count = 0;

                switch (this.currentPeriod) {
                    case 'week':
                        count = 7; // Last 7 days
                        for (let i = count - 1; i >= 0; i--) {
                            const date = new Date(now);
                            date.setDate(now.getDate() - i);
                            periods.push({
                                label: date.toLocaleDateString('ar-MA', { weekday: 'short' }),
                                start: new Date(date.setHours(0, 0, 0, 0)),
                                end: new Date(new Date(date).setHours(23, 59, 59, 999)) // Ensure end date is copy
                            });
                        }
                        break;
                    case 'month':
                        count = 12; // Last 12 months
                         for (let i = count -1; i >= 0; i--) { // Iterate from past to present for chart order
                            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                            const endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                            endDate.setHours(23,59,59,999);
                            periods.push({
                                label: date.toLocaleDateString('ar-MA', { month: 'short' }),
                                start: date,
                                end: endDate
                            });
                        }
                        break;
                    case 'quarter':
                        count = 4; // Last 4 quarters
                        for (let i = count - 1; i >= 0; i--) {
                            const currentQuarter = Math.floor(now.getMonth() / 3); // 0, 1, 2, 3
                            const yearOffset = Math.floor((currentQuarter * 3 - i * 3) / 12);
                            const monthStart = (currentQuarter * 3 - i * 3) % 12;
                            
                            const quarterStartDate = new Date(now.getFullYear() + yearOffset, monthStart < 0 ? 12 + monthStart : monthStart, 1);
                            const quarterEndDate = new Date(quarterStartDate.getFullYear(), quarterStartDate.getMonth() + 3, 0);
                            quarterEndDate.setHours(23,59,59,999);

                            periods.push({
                                label: `Q${Math.floor(quarterStartDate.getMonth() / 3) + 1} ${quarterStartDate.getFullYear()}`,
                                start: quarterStartDate,
                                end: quarterEndDate
                            });
                        }
                        break;
                    case 'year':
                        count = 5; // Last 5 years
                        for (let i = count - 1; i >= 0; i--) {
                            const year = now.getFullYear() - i;
                            periods.push({
                                label: year.toString(),
                                start: new Date(year, 0, 1),
                                end: new Date(year, 11, 31, 23, 59, 59, 999)
                            });
                        }
                        break;
                }
                return periods;
            }

            getPeriodText() {
                const texts = { week: 'التقرير الأسبوعي', month: 'التقرير الشهري', quarter: 'التقرير الربع سنوي', year: 'التقرير السنوي' };
                return texts[this.currentPeriod] || 'التقرير';
            }

            getDateRange() {
                const now = new Date();
                const periods = this.getPeriods();
                if (periods.length === 0) return 'غير محدد';

                const firstPeriod = periods[0];
                const lastPeriod = periods[periods.length - 1];

                return `${formatDateOnly(firstPeriod.start)} - ${formatDateOnly(lastPeriod.end)}`;
            }

            handlePeriodChange(button) {
                // Remove active styles from all buttons
                button.parentElement.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                });
                // Add active styles to the clicked button
                button.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-md');
                button.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                

                this.currentPeriod = button.dataset.period;
                this.updateReportData();
                Object.values(this.charts).forEach(chart => { if (chart) chart.destroy(); });
                this.initializeCharts();
            }

            // exportReport(type) { if (type === 'pdf') window.print(); } // Commented out as export is now directly linked to print
            printReport() {
                const reportSection = document.getElementById('reports-section');
                if (!reportSection) {
                    console.error("Reports section not found for printing.");
                    window.print(); // Fallback to default print if section not found
                    return;
                }

                const originalReportSectionDisplay = reportSection.style.display;
                // Storing full class lists to restore them accurately
                const originalBodyClassName = document.body.className;
                const originalHtmlClassName = document.documentElement.className;
                let safetyTimeoutId = null;

                // Define cleanup function locally to capture necessary variables
                const cleanupPrintStyles = () => {
                    document.body.className = originalBodyClassName;
                    document.documentElement.className = originalHtmlClassName;
                    reportSection.style.display = originalReportSectionDisplay;

                    // Remove event listeners
                    window.removeEventListener('afterprint', afterPrintHandler);
                    if (mql) { // mql is defined in the outer scope of printReport
                        if (mql.removeEventListener) {
                            mql.removeEventListener('change', mqlHandler);
                        } else if (mql.removeListener) { // Deprecated
                            mql.removeListener(mqlHandler);
                        }
                    }
                    if (safetyTimeoutId) clearTimeout(safetyTimeoutId);
                };

                const afterPrintHandler = () => {
                    cleanupPrintStyles();
                };

                const mqlHandler = (event) => {
                    if (!event.matches) { // When changing from print to screen
                        cleanupPrintStyles();
                    }
                };
                
                document.body.classList.add('print-mode-active');
                document.documentElement.classList.add('print-mode-active');
                reportSection.style.display = 'block';

                const mql = window.matchMedia ? window.matchMedia('print') : null;
                if (mql) {
                    if (mql.addEventListener) mql.addEventListener('change', mqlHandler, { once: true });
                    else if (mql.addListener) mql.addListener(mqlHandler);
                }
                window.addEventListener('afterprint', afterPrintHandler, { once: true });

                safetyTimeoutId = setTimeout(() => {
                    if (document.body.classList.contains('print-mode-active')) {
                        console.warn('Print events did not fire, restoring styles via timeout.');
                        cleanupPrintStyles();
                    }
                }, 3000);

                try { window.print(); } catch (e) { console.error("Error calling window.print():", e); cleanupPrintStyles(); }
            }
            showTableDetailsInModal(tableType) {
                const modalMainPanel = document.getElementById('generic-modal-main-panel');
                if (!modalMainPanel) {
                    console.error("Modal main panel #generic-modal-main-panel not found!");
                    // Fallback or return if critical
                } else {
                    // Reset to default width first, remove potentially wider classes
                    modalMainPanel.classList.remove('max-w-xl', 'max-w-2xl', 'max-w-3xl', 'max-w-4xl', 'max-w-5xl', 'max-w-6xl', 'max-w-7xl');
                    modalMainPanel.classList.add('max-w-lg'); // Ensure default is lg
                }

                let modalTitle = '';
                let tableHtml = '<p class="text-center text-gray-600">لا توجد بيانات لعرضها.</p>';
                let items = [];

                if (tableType === 'top-products') {
                    modalTitle = 'تفاصيل أعلى المنتجات سعراً';
                    items = [...appData.products].sort((a, b) => b.price - a.price); // Show all, sorted by price desc
                    if (items.length > 0) {
                        tableHtml = `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الفئة</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سعر البيع</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">سعر الجملة</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${items.map(p => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800">${p.name}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${p.category}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${formatCurrency(p.price)}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${p.quantity}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${formatCurrency(p.costPrice || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>`;
                    }
                } else if (tableType === 'recent-transactions') {
                    modalTitle = 'تفاصيل المعاملات الأخيرة';
                    if (modalMainPanel) {
                        modalMainPanel.classList.remove('max-w-lg');
                        modalMainPanel.classList.add('max-w-5xl'); // Make recent transactions modal wider
                    }

                    const invoices = appData.invoices || [];
                    const directSales = appData.directSales || [];
                    const salesTransactions = directSales.map(sale => ({ id: sale.id, amount: sale.total, status: 'paid', createdAt: new Date(sale.date), customerName: 'بيع مباشر', type: 'بيع مباشر', items: sale.items.map(item => `${item.name} (x${item.quantity})`).join(', ') }));
                    let allTransactions = [];
                    invoices.forEach(inv => allTransactions.push({ id: inv.id, amount: inv.total, status: 'paid', createdAt: new Date(inv.date), customerName: inv.customerName, type: 'فاتورة', items: inv.items.map(item => `${item.name} (x${item.quantity})`).join(', ') }));
                    allTransactions = allTransactions.concat(salesTransactions).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    items = allTransactions.slice(0, 25); // Show last 25 transactions in modal

                    if (items.length > 0) {
                        tableHtml = `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الزبون/النوع</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النوع</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العناصر</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${items.map(t => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${formatDateToFrench(t.createdAt)}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800">${t.customerName || 'بيع مباشر'}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${t.type}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${formatCurrency(t.amount)}</td>
                                            <td class="px-4 py-2 whitespace-normal text-xs text-gray-500">${t.items || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>`;
                    }
                }
                showGenericModal(modalTitle, `<div class="overflow-x-auto">${tableHtml}</div>`);
            }
        }

        // End of ReportsManager class

        let toastContainerEl = null;

        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - Type of toast (success, warning, error, info).
         * @param {number} duration - How long the toast stays visible (in ms).
         */
        function showToast(message, type = 'info', duration = 4000) {
            if (!toastContainerEl) {
                toastContainerEl = document.getElementById('toast-container');
                if (!toastContainerEl) {
                    console.error('Toast container #toast-container not found in HTML.');
                    return;
                }
            }

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            const fadeOutDelay = duration - 400; // Start fade-out animation before removal
            toast.style.setProperty('--toast-fade-delay', `${fadeOutDelay / 1000}s`);

            toastContainerEl.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode === toastContainerEl) {
                    toastContainerEl.removeChild(toast);
                }
            }, duration);
        }

        function deleteOldNotifications() {
            const twentyFourHoursAgo = new Date().getTime() - (24 * 60 * 60 * 1000);
            const originalCount = appData.notifications.length;
            appData.notifications = appData.notifications.filter(notification => {

                const notificationDate = notification.date instanceof Date ? notification.date : new Date(notification.date);
                return notificationDate.getTime() > twentyFourHoursAgo;
            });

            if (appData.notifications.length < originalCount) {
                saveData();
                updateNotificationDot();
            }
        }


        function formatDateToFrench(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                return ''; 
            }
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        /**
         * Formats a Date object to DD/MM/YYYY string.
         * @param {Date} date - The date to format.
         * @returns {string} Formatted date string or 'N/A'.
         */
        function formatDateOnly(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                return 'N/A';
            }
            return date.toLocaleDateString('fr-FR', { // Use fr-FR for DD/MM/YYYY with Western numerals
                day: '2-digit', month: '2-digit', year: 'numeric'
            });
        }
        function formatCurrency(value, currencySymbol = 'د.م.') {
            if (typeof value !== 'number') return `0.00 ${currencySymbol}`;
            return `${value.toFixed(2)} ${currencySymbol}`;
        }
        

        /**
         * Converts ISO date strings in loaded data back to Date objects.
         * @param {object} data - The raw data object loaded from localStorage.
         * @returns {object} The data object with Date objects restored.
         */
        function parseDatesInLoadedData(data) {
            if (data.credits) {
                data.credits.forEach(c => {
                    if (typeof c.date === 'string') c.date = new Date(c.date);
                });
            }
            if (data.invoices) {
                data.invoices.forEach(i => {
                    if (typeof i.date === 'string') i.date = new Date(i.date);
                });
            }
            if (data.notifications) {
                data.notifications.forEach(n => {
                    if (typeof n.date === 'string') n.date = new Date(n.date);
                    if (n.read === undefined) n.read = false; // Set default read status
                });
            }
            // Ensure dailySales.date is a Date object if it exists and is a string
            if (data.dailySales && typeof data.dailySales.date === 'string') {
                 // Convert 'YYYY-MM-DD' string back to Date object for comparison logic
                data.dailySales.date = new Date(data.dailySales.date);
            }
            // No date parsing needed for suppliers as it doesn't have a date field by default
            if (data.suppliers) {
                // If suppliers had dates, parse them here
                // e.g., data.suppliers.forEach(s => { if (typeof s.date === 'string') s.date = new Date(s.date); });
            }

            if (data.debts) { // NEW
                data.debts.forEach(d => {
                    if (typeof d.creationDate === 'string') {
                        const dt = new Date(d.creationDate);
                        d.creationDate = !isNaN(dt.getTime()) ? dt : null;
                    }
                    if (typeof d.dueDate === 'string') {
                        const dt = new Date(d.dueDate);
                        d.dueDate = !isNaN(dt.getTime()) ? dt : null;
                    }
                });
            }
            
            return data;
        }

        /**
         * Shows a generic modal with specified title and content.
         * @param {string} title - The title for the modal.
         * @param {string} contentHtml - The HTML string to inject into the modal's content area.
         */
        function showGenericModal(title, contentHtml) {
            genericModalTitle.textContent = title;
            genericModalContent.innerHTML = contentHtml;
            genericModal.classList.remove('hidden');
        }

        /**
         * Hides the generic modal.
         */
        function hideGenericModal() {
            genericModal.classList.add('hidden');
        }

        /**
         * Shows a confirmation modal with a message and a callback for confirmation.
         * @param {string} message - The message to display.
         * @param {function} onConfirmCallback - The function to execute if confirmed.
         */
        function showConfirmationModal(message, onConfirmCallback) {
            confirmModalMessage.textContent = message;
            appData.currentConfirmationCallback = onConfirmCallback; // Store callback
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Hides the confirmation modal and clears the callback.
         */
        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            appData.currentConfirmationCallback = null;
        }

        /**
         * Handles the confirmation action in the confirmation modal.
         */
        function handleConfirmAction() {
            if (appData.currentConfirmationCallback) {
                appData.currentConfirmationCallback();
            }
            hideConfirmationModal();
        }

        /**
         * Handles the cancel action in the confirmation modal.
         */
        function handleCancelAction() {
            hideConfirmationModal();
        }

        /**
         * Adds a new notification to the appData and re-renders notifications.
         * @param {string} message - The notification message.
         * @param {string} toastType - The type of toast to show (success, error, warning, info).
         */
        function addNotification(message, toastType = 'info') {
            appData.notifications.push({ message, date: new Date(), read: false }); // Mark as unread
            saveData();
            updateNotificationDot();
            // Re-render if modal is open, otherwise it will update on next open
            if (!genericModal.classList.contains('hidden') && genericModalTitle.textContent === 'الإشعارات') {
                renderNotificationsModal();
            }
            showToast(message, toastType); // Show toast notification
        }

        /**
         * Updates the visibility of the notification dot.
         */
        function updateNotificationDot() {
            const unreadNotifications = appData.notifications.filter(n => !n.read);
            if (unreadNotifications.length > 0) {
                notificationDot.classList.remove('hidden');
            } else {
                notificationDot.classList.add('hidden');
            }
        }

        /**
         * Marks all notifications as read.
         */
        function markAllNotificationsAsRead() {
            appData.notifications.forEach(n => n.read = true);
            saveData();
            updateNotificationDot();
        }

        /**
         * Prints the provided HTML content in a new window.
         * @param {string} htmlContent - The HTML content to print.
         * @param {string} title - The title for the print window.
         * @param {string} printType - Type of print ('standard' or 'thermal').
         */
        function printContent(htmlContent, title, printType = 'standard') {
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open(); // Open the document for writing

                let actualCssRules = ''; // Variable to hold only CSS rules

                if (printType === 'standard') {
                    actualCssRules = `
                            body { font-family: 'Inter', sans-serif; margin: 20px; direction: rtl; text-align: right; background-color: #fff; color: #000;}
                            h1, h2, h3, p { margin: 0 0 5px 0; padding: 0; }
                            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                            th, td { border: 1px solid #ddd; padding: 4px; text-align: right; font-size: 9pt; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .text-left { text-align: left; }
                            .font-bold { font-weight: bold; }
                            .text-xl { font-size: 1.25rem; }
                            .text-blue-600 { color: #2563eb; }
                            .status-paid { color: green; font-weight: bold; }
                            .status-unpaid { color: red; font-weight: bold; }
                            @page {
                                size: auto;
                                margin: 0mm;
                            }
                            body {
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            svg.barcode { display: block; margin: 10px auto; }
                    `;
                } else if (printType === 'thermal') {
                    actualCssRules = `
                        body {
                            font-family: 'SF Mono', 'Menlo', 'Consolas', 'Courier New', Courier, monospace; /* Monospaced font for alignment */
                            font-size: 9pt; /* Base font size */
                            line-height: 1.2;
                            color: #000;
                            background-color: #fff;
                            margin: 0;
                            padding: 2mm 3mm; /* Small padding around content */
                            width: 72mm; /* For 80mm paper. Adjust to ~52mm for 58mm paper */
                            box-sizing: border-box;
                            direction: rtl;
                            -webkit-print-color-adjust: exact !important; /* For Chrome/Safari */
                            color-adjust: exact !important;               /* Standard */
                        }

                        .store-name-thermal {
                            font-size: 12pt; /* Slightly larger store name */
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 2mm;
                        }

                        .invoice-header-thermal {
                            font-size: 8pt;
                            margin-bottom: 2mm;
                            text-align: right; /* Align the block to the right */
                        }
                        .invoice-header-thermal div {
                            margin: 0.5mm 0;
                        }
                        .invoice-header-thermal div strong {
                            display: inline-block; 
                            min-width: 50px; /* Adjust as needed for "فاتورة رقم:" etc. */
                        }

                        .items-table-thermal {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 2mm 0;
                            font-size: 8pt;
                        }
                        .items-table-thermal th, .items-table-thermal td {
                            padding: 0.5mm 0; /* Minimal vertical padding */
                            vertical-align: top;
                            border: none;
                        }
                        .items-table-thermal thead th {
                            border-top: 1px dashed #000;
                            border-bottom: 1px dashed #000;
                            font-weight: bold;
                            padding: 1mm 0;
                            /* text-align will be set by inline styles in HTML from handlePrintInvoice */
                        }
                        .items-table-thermal td.item-name {
                            text-align: right;
                            word-break: break-word;
                            padding-right: 1mm; /* Small padding for item name */
                        }
                        .items-table-thermal td.item-total {
                            text-align: left;
                            padding-left: 1mm; /* Small padding for total */
                        }
                        .items-table-thermal td.item-qty-details { /* e.g., 2 x 15.00 */
                            text-align: right;
                            font-size: 7.5pt; /* Slightly smaller */
                            color: #333;
                            padding-top: 0;
                            padding-bottom: 1mm; /* Space after qty/price line */
                            /* padding-right: 5mm; is handled by inline style in handlePrintInvoice */
                        }

                        .totals-thermal {
                            margin-top: 2mm;
                            padding-top: 1.5mm; /* Space above the line */
                            border-top: 1px dashed #000; /* Separator line */
                            font-size: 9.5pt; /* Slightly larger for totals */
                        }
                        .totals-thermal p {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            margin: 1mm 0;
                        }
                        .totals-thermal p span:first-child { text-align: right; }
                        .totals-thermal p span:last-child { text-align: left; }

                        .thank-you-thermal {
                            font-size: 8pt;
                            margin-top: 3mm; /* More space before thank you */
                            margin-bottom: 1mm;
                            text-align: center;
                        }

                        svg.barcode-svg { /* تم تصحيح اسم الكلاس هنا ليطابق HTML */
                            display: block;
                            margin: 2mm auto 1mm auto; /* top/bottom L/R */
                            width: 90% !important; /* Relative to 72mm body */
                            max-width: 60mm; /* Absolute max */
                            height: 30px !important; /* Fixed height */
                        }
                        .store-logo-thermal {
                            display: block;
                            max-width: 50mm; /* Adjust as needed */
                            max-height: 40px; /* Adjust as needed */
                            margin: 0 auto 2mm auto; /* Center and add some space below */
                        }

                        @page {
                            size: 80mm auto; /* Adjust width for 58mm paper to e.g. 58mm */
                            margin: 0mm;
                        }
                    `;
                }
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${title}</title>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"><\/script>
                        <style>${actualCssRules}</style>
                    </head>
                    <body>${htmlContent}</body>
                    </html>`);
                printWindow.document.close();
                printWindow.focus();
                // Use a timeout to ensure JsBarcode has time to render SVG
                printWindow.onload = () => {
                     // Generate barcodes after content is loaded in the new window
                    if (printWindow.JsBarcode) {
                        printWindow.document.querySelectorAll('.barcode-svg').forEach(svgElement => {
                            try {
                                printWindow.JsBarcode(svgElement, svgElement.dataset.value, {
                                    format: "CODE128", // Common barcode format
                                    displayValue: true,
                                    width: printType === 'thermal' ? 1.2 : 1.5,
                                    height: printType === 'thermal' ? 30 : 50,
                                    margin: printType === 'thermal' ? 2 : 5,
                                    fontSize: printType === 'thermal' ? 10 : 12,
                                    textMargin: printType === 'thermal' ? 0 : 2,
                                });
                            } catch (e) {
                                console.error("Error generating barcode:", e);
                            }
                        });
                    }
                    printWindow.print();
                    // printWindow.onafterprint = () => printWindow.close(); // Optional: close after printing
                };
            } else {
                addNotification('تعذر فتح نافذة الطباعة. قد تكون النوافذ المنبثقة محظورة.', 'warning');
            }
        }

        /**
         * Resets daily sales data if a new day has started.
         */
        function resetDailySalesIfNewDay() {
            const today = new Date();
            const todayString = today.toISOString().slice(0, 10); //YYYY-MM-DD
            if (appData.dailySales.date !== todayString) {
                appData.dailySales = {
                    date: todayString,
                    hourlySales: Array(24).fill(0)
                };
                saveData();
                console.log('Daily sales data reset for a new day.');
            }
        }

        /**
         * Updates the daily sales data for the current hour.
         * @param {number} amount - The sale amount to add.
         */
        function updateDailySales(amount) {
            const now = new Date();
            const currentHour = now.getHours(); // 0-23
            // Ensure today's data is active
            resetDailySalesIfNewDay();
            appData.dailySales.hourlySales[currentHour] += amount;
            saveData();
            // Re-render charts if reports section is active
            if (appData.activeTab === 'reports') {
                drawDailySalesChart();
            }
        }

        // --- Data Storage (localStorage) ---

        /**
         * Saves current appData to localStorage.
         */
        function saveData() {
            try {
                // Convert Date objects to ISO strings for proper JSON serialization
                const dataToSave = {
                    products: appData.products || [],
                    credits: (appData.credits || []).map(c => ({ ...c, date: c.date.toISOString() })),
                    invoices: (appData.invoices || []).map(i => ({ ...i, date: i.date.toISOString() })),
                    suppliers: appData.suppliers || [],
                    directSales: appData.directSales || [], 
                    debts: (appData.debts || []).map(d => ({
                        ...d,
                        creationDate: d.creationDate instanceof Date && !isNaN(d.creationDate.getTime()) ? d.creationDate.toISOString() : null,
                        dueDate: d.dueDate instanceof Date && !isNaN(d.dueDate.getTime()) ? d.dueDate.toISOString() : null
                    })), // NEW: Save debts with dates
                    cartItems: appData.cartItems || [],
                    notifications: (appData.notifications || []).map(n => ({ ...n, date: n.date.toISOString(), read: n.read })),
                    dailySales: {
                        date: appData.dailySales ? appData.dailySales.date : new Date().toISOString().slice(0,10),
                        hourlySales: appData.dailySales ? appData.dailySales.hourlySales : Array(24).fill(0)
                    },
                    monthlySalesData: appData.monthlySalesData,
                    weeklySalesData: appData.weeklySalesData,
                    storeName: appData.storeName,
                    storeLogo: appData.storeLogo, // NEW: Save store logo
                    activeTab: appData.activeTab
                };
                localStorage.setItem('quantixAppData', JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                // Directly show toast to avoid recursion if addNotification calls saveData
                showToast("فشل حفظ البيانات. قد يكون هناك مشكلة في التخزين المحلي.", 'error');
            }
        }

        /**
         * Loads appData from localStorage.
         */
        function loadData() {
            try {
                const storedData = localStorage.getItem('quantixAppData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    appData = parseDatesInLoadedData(parsedData);
                    // Ensure dailySales date string is correctly parsed and checked
                    // Re-initialize dailySales if it's missing or in an old format
                    appData.searchTerm = typeof appData.searchTerm === 'string' ? appData.searchTerm : '';
                    if (!appData.dailySales || typeof appData.dailySales.hourlySales === 'undefined') {
                        appData.dailySales = {
                            date: new Date().toISOString().slice(0, 10),
                            hourlySales: Array(24).fill(0)
                        };
                    } else if (typeof appData.dailySales.date !== 'string') {
                         // If date was loaded as Date object (from parseDatesInLoadedData), convert it back to string for consistency
                         appData.dailySales.date = new Date(appData.dailySales.date).toISOString().slice(0, 10);
                    }
                    deleteOldNotifications(); // Delete old notifications on load
                    resetDailySalesIfNewDay(); // Ensure daily sales is for current day

                    // NEW: Load store name
                    appData.storeName = parsedData.storeName || '';
                    appData.storeLogo = parsedData.storeLogo || null; // NEW: Load store logo
                    appData.suppliers = parsedData.suppliers || []; // NEW: Load suppliers
                    appData.directSales = parsedData.directSales || []; // NEW: Load direct sales
                    appData.debts = parsedData.debts ? parsedData.debts.map(d => ({ // NEW: Load debts
                        ...d,
                        creationDate: new Date(d.creationDate),
                        dueDate: new Date(d.dueDate)
                    })) : [];
                    currentStoreLogoSrc = appData.storeLogo; // NEW: Set session variable from loaded logo
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                addNotification("فشل تحميل البيانات. تم البدء ببيانات جديدة.", 'error');
                // Reset to default empty state if loading fails
                appData = {
                    products: [],
                    credits: [],
                    invoices: [],
                    suppliers: [], // NEW: Initialize suppliers
                    directSales: [], // NEW: Initialize direct sales
                    debts: [], // NEW: Initialize debts
                    cartItems: [],
                    notifications: [],
                    dailySales: {
                        date: new Date().toISOString().slice(0, 10),
                        hourlySales: Array(24).fill(0)
                    },
                    monthlySalesData: {},
                    weeklySalesData: {},
                    storeName: '', // Initialize empty on load error
                    storeLogo: null, // Initialize empty on load error
                    activeTab: 'inventory',
                    searchTerm: '', // Initialize empty search term
                    debtToEditId: null, // NEW
                };
            }
        }

        // --- Specific Low Stock Notification ---
        /**
         * Checks if a product is low on stock or out of stock after a quantity change and shows a toast.
         * @param {string} productId - The ID of the product.
         * @param {number} oldQuantity - The quantity of the product before the change.
         */
        function checkAndNotifyLowStock(productId, oldQuantity) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;

            const newQuantity = product.quantity;
            const lowStockThreshold = 3; // As per user request

            if (newQuantity <= lowStockThreshold && newQuantity > 0 && oldQuantity > lowStockThreshold) {
                showToast(`المنتج "${product.name}" وصل إلى حد المخزون المنخفض (${newQuantity} متبقية).`, 'warning', 5000);
            } else if (newQuantity === 0 && oldQuantity > 0) {
                showToast(`المنتج "${product.name}" نفذ من المخزون.`, 'error', 5000);
            }
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the current active tab's content.
         */
        function renderContent() {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${appData.activeTab}-section`).classList.add('active');

            // Render specific section content
            switch (appData.activeTab) {
                case 'inventory':
                    renderInventorySection();
                    break;
                case 'low-stock': // NEW
                    renderLowStockSection();
                    break;
                case 'credit':
                    renderCreditSection();
                    break;
                case 'invoices':
                    renderInvoicesSection();
                    break;
                case 'reports':
                    renderReportsSection();
                    break;
                case 'suppliers': // NEW
                    renderSuppliersSection();
                     // Ensure category options are updated whenever the suppliers section is rendered
                    break;
                case 'debts': // NEW
                    renderDebtsSection();
                    break;
            }
            renderTopBar(); // Ensure cart count etc. are updated
        }


        /**
         * Updates the top bar elements like cart count.
         */
        function renderTopBar() {
            cartCountSpan.textContent = appData.cartItems.length;
            if (appData.cartItems.length > 0) {
                cartCountSpan.classList.remove('hidden');
            } else {
                cartCountSpan.classList.add('hidden');
            }
            // Ensure search input starts empty
            if (searchInput.value !== appData.searchTerm) { // Only update if different to avoid cursor jump
                searchInput.value = appData.searchTerm;
            }
            updateNotificationDot(); // Update dot based on unread notifications
            updateUndoResetButtonsState(); // Update states of Undo and Reset buttons
        }

        /**
         * Updates the enabled/disabled state of Undo and Reset Cart buttons.
         */
        function updateUndoResetButtonsState() {
            if (undoLastTransactionButton) {
                undoLastTransactionButton.disabled = !appData.lastTransaction;
            }
            if (resetCartStockButton) {
                resetCartStockButton.disabled = appData.cartItems.length === 0;
            }
            // This function will be called by renderTopBar and after specific actions
        }

        /**
         * Renders the product cards in the inventory section.
         */
        function renderInventorySection() {
            let filteredProducts = [...appData.products];

            // Apply search filter
        appData.searchTerm = searchInput.value.trim();
            if (appData.searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    p.category.toLowerCase().includes(appData.searchTerm.toLowerCase())
                );
            }
        
            if (inventoryCategoryFilter && inventoryCategoryFilter.value !== 'all' && inventoryCategoryFilter.value !== '') {
                console.log("Filtering by category:", inventoryCategoryFilter.value); // Debugging line
                filteredProducts = filteredProducts.filter(p => p.category === inventoryCategoryFilter.value);
            }

            // Apply sorting
            const sortOption = inventorySortSelect.value;
            switch (sortOption) {


                case 'name-asc':
                    filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    filteredProducts.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'price-asc':
                    filteredProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    filteredProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'quantity-asc':
                    filteredProducts.sort((a, b) => a.quantity - b.quantity);
                    break;
                case 'quantity-desc':
                    filteredProducts.sort((a, b) => b.quantity - a.quantity);
                    break;
                default:
                    break;
            }

            productsGrid.innerHTML = ''; // Clear previous cards

            if (filteredProducts.length === 0) {
                if (appData.searchTerm) {
                    noProductsMessage.classList.add('hidden');
                    noSearchResultsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.remove('hidden');
                    noSearchResultsMessage.classList.add('hidden');
                }
            } else {
                noProductsMessage.classList.add('hidden');
                noSearchResultsMessage.classList.add('hidden');
                filteredProducts.forEach(product => {
                    let quantityColorClass = 'text-gray-600';
                    if (product.quantity === 0) {
                        quantityColorClass = 'text-red-600 font-bold';
                    } else if (product.quantity <= 3) {
                        quantityColorClass = 'text-orange-500 font-bold';
                    }

                    const cardHtml = `
                        <div class="product-card bg-white rounded-xl shadow-lg p-4 flex flex-col items-center text-center" data-category="${product.category}">
                            <img
                                src="${product.imageUrl || 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة'}"
                                alt="${product.name}"
                                class="w-40 h-40 object-contain mb-4 rounded-lg"
                                onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة';"
                            />
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${product.name}</h3>
                            <p class="text-sm text-gray-600">الفئة: ${product.category}</p>
                            <p class="text-sm ${quantityColorClass} mb-2">الكمية: ${product.quantity}</p>
                            <p class="text-xl font-bold text-blue-600 mb-4">${product.price.toFixed(2)} د.م.</p>
                            <div class="flex gap-2 w-full justify-center">
                                <button
                                    data-product-id="${product.id}"
                                    class="add-to-cart-button flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 text-sm ${product.quantity <= 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${product.quantity <= 0 ? 'disabled' : ''}
                                >
                                    أضف إلى السلة
                                </button>
                                <button
                                    data-product-id="${product.id}"
                                    class="edit-product-button p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200"
                                    title="تعديل"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                </button>
                                <button
                                    data-product-id="${product.id}"
                                    class="delete-product-button p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-200"
                                    title="حذف"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    productsGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
                // Re-attach event listeners for dynamically added buttons
                attachInventoryEventListeners();
            }
        }

        /**
         * NEW: Renders the low stock products section.
         */
        function renderLowStockSection() {
            let lowStockProducts = appData.products.filter(p => p.quantity <= 3);
            lowStockProducts.sort((a, b) => a.quantity - b.quantity); // Order by quantity, lowest first

            lowStockProductsGrid.innerHTML = ''; // Clear previous cards

            if (lowStockProducts.length === 0) {
                noLowStockMessage.classList.remove('hidden');
            } else {
                noLowStockMessage.classList.add('hidden');
                lowStockProducts.forEach(product => {
                    let quantityColorClass = 'text-gray-600';
                    if (product.quantity === 0) {
                        quantityColorClass = 'text-red-600 font-bold';
                    } else if (product.quantity <= 3) {
                        quantityColorClass = 'text-orange-500 font-bold';
                    }
                    const cardHtml = `
                        <div class="bg-white rounded-xl shadow-lg p-4 flex flex-col items-center text-center border-2 border-yellow-300">
                            <svg class="w-8 h-8 text-yellow-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            <img
                                src="${product.imageUrl || 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة'}"
                                alt="${product.name}"
                                class="w-40 h-40 object-contain mb-4 rounded-lg"
                                onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة';"
                            />
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${product.name}</h3>
                            <p class="text-sm text-gray-600">الفئة: ${product.category}</p>
                            <p class="text-sm ${quantityColorClass} mb-2">الكمية: ${product.quantity} (مخزون منخفض!)</p>
                            <p class="text-xl font-bold text-blue-600 mb-4">${product.price.toFixed(2)} د.م.</p>
                            <div class="flex gap-2 w-full justify-center">
                                <button
                                    data-product-id="${product.id}"
                                    class="add-to-cart-button flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 text-sm ${product.quantity <= 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${product.quantity <= 0 ? 'disabled' : ''}
                                >
                                    أضف إلى السلة
                                </button>
                                <button
                                    data-product-id="${product.id}"
                                    class="edit-product-button p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200"
                                    title="تعديل"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                </button>
                                <button
                                    data-product-id="${product.id}"
                                    class="delete-product-button p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-200"
                                    title="حذف"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    lowStockProductsGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
                // Re-attach event listeners for dynamically added buttons (same as inventory section)
                attachInventoryEventListeners();
            }
        }

        /**
         * NEW: Renders the supplier cards in the suppliers section.
         */
        function renderSuppliersSection() {
            let filteredSuppliers = [...appData.suppliers];

            // Apply search filter (if search is intended for suppliers too)
            appData.searchTerm = searchInput.value.trim();
            if (appData.searchTerm) {
                filteredSuppliers = filteredSuppliers.filter(s =>
                    s.name.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    (s.company && s.company.toLowerCase().includes(appData.searchTerm.toLowerCase())) ||
                    (s.phone && s.phone.includes(appData.searchTerm)) ||
                    (s.email && s.email.toLowerCase().includes(appData.searchTerm.toLowerCase()))
                );
            }

            // Apply sorting
            const sortOption = suppliersSortSelect.value;
            switch (sortOption) {
                case 'name-asc':
                    filteredSuppliers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    filteredSuppliers.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'company-asc':
                    filteredSuppliers.sort((a, b) => (a.company || '').localeCompare(b.company || ''));
                    break;
                case 'company-desc':
                    filteredSuppliers.sort((a, b) => (b.company || '').localeCompare(a.company || ''));
                    break;
                default:
                    break;
            }

            suppliersGrid.innerHTML = ''; // Clear previous cards

            if (filteredSuppliers.length === 0) {
                noSuppliersMessage.classList.remove('hidden');
            } else {
                noSuppliersMessage.classList.add('hidden');
                filteredSuppliers.forEach(supplier => {
                    const cardHtml = `
                        <div class="bg-white rounded-xl shadow-lg p-4 flex flex-col text-right">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">${supplier.name}</h3>
                            ${supplier.company ? `<p class="text-sm text-gray-600 mb-1">الشركة: ${supplier.company}</p>` : ''}
                            <p class="text-sm text-gray-600 mb-1">الهاتف: ${supplier.phone}</p>
                            ${supplier.email ? `<p class="text-sm text-gray-600 mb-1">البريد: ${supplier.email}</p>` : ''}
                            ${supplier.address ? `<p class="text-sm text-gray-500 mb-3">العنوان: ${supplier.address.substring(0, 50)}${supplier.address.length > 50 ? '...' : ''}</p>` : ''}
                            <div class="mt-auto flex gap-2 w-full justify-end">
                                <button data-supplier-id="${supplier.id}" class="edit-supplier-button p-2 bg-gray-200 text-indigo-600 rounded-lg hover:bg-gray-300 transition duration-200" title="تعديل"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                                <button data-supplier-id="${supplier.id}" class="delete-supplier-button p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-200" title="حذف"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </div>
                    `;
                    suppliersGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
                attachSupplierEventListeners();
            }
        }

        /**
         * Renders the credits table in the credit section.
         */
        function renderCreditSection() {
            let filteredCredits = [...appData.credits];

            // Apply search filter
            appData.searchTerm = searchInput.value.trim(); // Get current search term from input
            if (appData.searchTerm) {
                filteredCredits = filteredCredits.filter(c =>
                    c.customer.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    c.product.toLowerCase().includes(appData.searchTerm.toLowerCase())
                );
            }

            // Apply status filter
            const filterStatus = creditStatusFilter.value;
            if (filterStatus !== 'all') {
                filteredCredits = filteredCredits.filter(c => c.status === filterStatus);
            }

            // Apply sorting
            const sortOption = creditSortSelect.value;
            switch (sortOption) {
                case 'date-desc':
                    filteredCredits.sort((a, b) => b.date.getTime() - a.date.getTime());
                    break;
                case 'date-asc':
                    filteredCredits.sort((a, b) => a.date.getTime() - b.date.getTime());
                    break;
                case 'name-asc':
                    filteredCredits.sort((a, b) => a.customer.localeCompare(b.customer));
                    break;
                case 'name-desc':
                    filteredCredits.sort((a, b) => b.customer.localeCompare(a.customer));
                    break;
                default:
                    break;
            }

            if (filteredCredits.length === 0) {
                creditsTableContainer.innerHTML = ''; // Clear table
                noCreditsMessage.classList.remove('hidden');
            } else {
                noCreditsMessage.classList.add('hidden');
                const tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الزبون</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الثمن (د.م.)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filteredCredits.map(credit => `
                                <tr class="${credit.status === 'paid' ? 'bg-green-50' : 'bg-red-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 font-medium">${credit.customer}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${credit.product}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${credit.amount.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${formatDateToFrench(credit.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                            ${credit.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${credit.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex gap-2 justify-end">
                                            <button
                                                data-credit-id="${credit.id}"
                                                class="edit-credit-button text-indigo-600 hover:text-indigo-900 p-2 rounded-md hover:bg-gray-100"
                                                title="تعديل"
                                            >
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                            </button>
                                            <button
                                                data-credit-id="${credit.id}"
                                                class="print-credit-button bg-gray-100 text-blue-700 px-2 py-2 rounded-lg hover:bg-blue-100 transition duration-200"
                                                title="طباعة عادية">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            </button>
                                            <button
                                                data-credit-id="${credit.id}"
                                                class="print-credit-thermal-button bg-gray-100 text-orange-700 px-2 py-2 rounded-lg hover:bg-orange-100 transition duration-200"
                                                title="طباعة حرارية">
                                                <!-- Icon for thermal print, e.g., a receipt icon -->
                                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                            </button>
                                            <button
                                                data-credit-id="${credit.id}"
                                                class="mark-paid-button bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 transition duration-200 ${credit.status === 'paid' ? 'opacity-50 cursor-not-allowed' : ''}"
                                                ${credit.status === 'paid' ? 'disabled' : ''}
                                            >
                                                تم الدفع
                                            </button>
                                            <button
                                                data-credit-id="${credit.id}"
                                                class="delete-credit-button bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition duration-200"
                                            >
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                creditsTableContainer.innerHTML = tableHtml;
                // Re-attach event listeners for dynamically added buttons
                attachCreditEventListeners();
            }
        }


        /**
         * NEW: Renders the debts table in the debts section.
         */
        function renderDebtsSection() {
            let filteredDebts = [...appData.debts];

            // Apply search filter (if search is intended for debts too)
            appData.searchTerm = searchInput.value.trim();
            if (appData.searchTerm) {
                filteredDebts = filteredDebts.filter(d =>
                    d.creditorName.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    (d.description && d.description.toLowerCase().includes(appData.searchTerm.toLowerCase()))
                );
            }

            // Apply status filter
            const filterStatus = debtStatusFilter.value;
            if (filterStatus !== 'all') {
                filteredDebts = filteredDebts.filter(d => d.status === filterStatus);
            }

            // Apply sorting
            const sortOption = debtSortSelect.value;
            switch (sortOption) {
                case 'dueDate-asc':
                    filteredDebts.sort((a, b) => {
                        if (a.dueDate === null && b.dueDate === null) return 0;
                        if (a.dueDate === null) return 1; // nulls last
                        if (b.dueDate === null) return -1; // nulls last
                        return a.dueDate.getTime() - b.dueDate.getTime();
                    });
                    break;
                case 'dueDate-desc':
                    filteredDebts.sort((a, b) => {
                        if (a.dueDate === null && b.dueDate === null) return 0;
                        if (a.dueDate === null) return 1; // nulls last
                        if (b.dueDate === null) return -1; // nulls last
                        // For descending, if a.dueDate is smaller, it comes later (larger sort value)
                        // and if b.dueDate is smaller, it comes earlier (smaller sort value)
                        return b.dueDate.getTime() - a.dueDate.getTime();
                    });
                    break;
                case 'creditorName-asc':
                    filteredDebts.sort((a, b) => a.creditorName.localeCompare(b.creditorName));
                    break;
                case 'creditorName-desc':
                    filteredDebts.sort((a, b) => b.creditorName.localeCompare(a.creditorName));
                    break;
                case 'amount-desc':
                    filteredDebts.sort((a, b) => b.amount - a.amount);
                    break;
                case 'amount-asc':
                    filteredDebts.sort((a, b) => a.amount - b.amount);
                    break;
                default:
                    break;
            }

            if (filteredDebts.length === 0) {
                debtsTableContainer.innerHTML = '';
                noDebtsMessage.classList.remove('hidden');
            } else {
                noDebtsMessage.classList.add('hidden');
                const tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الدائن</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الوصف</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ (د.م.)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ الاستحقاق</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ الإنشاء</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filteredDebts.map(debt => `
                                <tr class="${debt.status === 'paid' ? 'bg-green-50' : 'bg-red-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 font-medium">${debt.creditorName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${debt.description || '-'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${debt.amount.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${formatDateOnly(debt.dueDate)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${formatDateOnly(debt.creationDate)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                            ${debt.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${debt.status === 'paid' ? 'تم الأداء' : 'باقي'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex gap-2 justify-end">
                                            <button data-debt-id="${debt.id}" class="edit-debt-button text-indigo-600 hover:text-indigo-900 p-2 rounded-md hover:bg-gray-100" title="تعديل"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                                            <button data-debt-id="${debt.id}" class="mark-debt-paid-button bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 transition duration-200 ${debt.status === 'paid' ? 'opacity-50 cursor-not-allowed' : ''}" ${debt.status === 'paid' ? 'disabled' : ''}>تم الأداء</button>
                                            <button data-debt-id="${debt.id}" class="delete-debt-button bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition duration-200">حذف</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                debtsTableContainer.innerHTML = tableHtml;
                attachDebtEventListeners();
            }
        }


        /**
         * Renders the invoices table in the invoices section.
         */
        function renderInvoicesSection() {
            // Sort invoices by date, newest first
            let sortedInvoices = [...appData.invoices].sort((a, b) => b.date.getTime() - a.date.getTime());

            appData.searchTerm = searchInput.value.trim(); // Get current search term from input
            if (appData.searchTerm) {
                sortedInvoices = sortedInvoices.filter(inv =>
                    inv.invoiceNumber.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    inv.customerName.toLowerCase().includes(appData.searchTerm.toLowerCase())
                );
            }

            if (sortedInvoices.length === 0) {
                invoicesTableContainer.innerHTML = '';
                noInvoicesMessage.classList.remove('hidden');
            } else {
                noInvoicesMessage.classList.add('hidden');
                const tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم الفاتورة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم الزبون</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجمالي (د.م.)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${sortedInvoices.map(invoice => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-800">${invoice.invoiceNumber}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${invoice.customerName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${formatDateToFrench(invoice.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${invoice.total.toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex gap-2 justify-end">
                                            <button
                                                data-invoice-id="${invoice.id}"
                                                class="print-invoice-standard-button bg-gray-100 text-blue-700 px-2 py-2 rounded-lg hover:bg-blue-100 transition duration-200"
                                                title="طباعة عادية"
                                            >
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            </button>
                                            <button
                                                data-invoice-id="${invoice.id}"
                                                class="view-print-invoice-button bg-gray-100 text-orange-700 px-2 py-2 rounded-lg hover:bg-orange-100 transition duration-200"
                                                title="طباعة حرارية"
                                            >
                                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                            </button>
                                            <button
                                                data-invoice-id="${invoice.id}"
                                                class="delete-invoice-button bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition duration-200"
                                            >
                                                حذف
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                invoicesTableContainer.innerHTML = tableHtml;
                attachInvoiceEventListeners();
            }
        }

        /**
         * Renders the reports section with summaries and charts.
         */
        function renderReportsSection() {
            console.log("[DEBUG] renderReportsSection called. Active tab:", appData.activeTab); // This log is fine here
            const reportsPageContainer = document.getElementById('reports-section');
            if (!reportsPageContainer) {
                console.error("[DEBUG] #reports-section container NOT FOUND in DOM!");
                return;
            }
            console.log("[DEBUG] #reports-section found. Current display style:", window.getComputedStyle(reportsPageContainer).display);
            // Ensure it's active if this function is called
            if (!reportsPageContainer.classList.contains('active')) {
                console.warn("[DEBUG] #reports-section was not active, adding 'active' class.");
                reportsPageContainer.classList.add('active');
            }
            console.log("[DEBUG] #reports-section display style after ensuring active:", window.getComputedStyle(reportsPageContainer).display);

            if (!reportsManagerInstance) {
                console.log("[DEBUG] Creating new ReportsManager instance");
                try {
                    reportsManagerInstance = new ReportsManager();
                } catch (e) {
                    console.error("Error creating ReportsManager:", e);
                    return; // Stop if manager cannot be created
                }
            }

            // Check if reports HTML is already loaded by looking for a known element
            const isHtmlLoaded = reportsPageContainer.querySelector('.page-header');
            console.log("[DEBUG] isHtmlLoaded (checks for .page-header):", !!isHtmlLoaded);

            if (!isHtmlLoaded) {
                console.log("[DEBUG] HTML not loaded, calling reportsManagerInstance.loadReports()");
                try {
                    reportsManagerInstance.loadReports(); // This injects HTML and initializes charts the first time
                } catch (e) {
                    console.error("[DEBUG] Error during reportsManagerInstance.loadReports():", e);
                }
            } else {
                console.log("[DEBUG] HTML already loaded, updating report data and charts.");
                // If HTML is already there, just update data and charts
                try {
                    reportsManagerInstance.updateReportData();
                    Object.values(reportsManagerInstance.charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') chart.destroy();
                    });
                    reportsManagerInstance.initializeCharts();
                } catch (e) {
                    console.error("[DEBUG] Error during report data/chart update:", e);
                }
            }
            console.log("[DEBUG] reports-section innerHTML (first 100 chars after renderReportsSection):", reportsPageContainer.innerHTML.substring(0, 100));
            console.log("[DEBUG] reports-section computed height:", window.getComputedStyle(reportsPageContainer).height);
        }
        


        // --- Modal Content and Handlers ---

        /**
         * Renders the cart modal content.
         */
        function renderCartModal() {
            let cartContentHtml = '';
            if (appData.cartItems.length === 0) {
                cartContentHtml = '<p class="text-center text-gray-600">السلة فارغة.</p>';
            } else {
                const total = appData.cartItems.reduce((sum, item) => {
                    const product = appData.products.find(p => p.id === item.productId);
                    return sum + (product ? product.price * item.quantity : 0);
                }, 0);

                cartContentHtml = `
                    <div class="space-y-4">
                        ${appData.cartItems.map(item => {
                            const product = appData.products.find(p => p.id === item.productId);
                            if (!product) return '';
                            return `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm">
                                    <div class="flex items-center space-x-3 rtl:space-x-reverse">
                                        <img src="${product.imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة';"/>
                                        <div>
                                            <h3 class="font-semibold text-gray-800">${product.name}</h3>
                                            <p class="text-sm text-gray-600">${product.price.toFixed(2)} د.م.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3 rtl:space-x-reverse">
                                        <button data-product-id="${item.productId}" data-action="decrease" class="update-cart-quantity-button bg-blue-100 text-blue-700 px-2 py-1 rounded-md hover:bg-blue-200 ${item.quantity <= 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${item.quantity <= 1 ? 'disabled' : ''}>
                                            -
                                        </button>
                                        <input type="number"
                                               value="${item.quantity}"
                                               min="1"
                                               data-product-id="${item.productId}"
                                               class="cart-item-quantity-input w-16 text-center border border-gray-300 rounded-md py-1 px-2 mx-1 focus:ring-blue-500 focus:border-blue-500"
                                               aria-label="كمية المنتج ${product.name}"
                                        />
                                        <button data-product-id="${item.productId}" data-action="increase" class="update-cart-quantity-button bg-blue-100 text-blue-700 px-2 py-1 rounded-md hover:bg-blue-200">
                                            +
                                        </button>
                                        <button data-product-id="${item.productId}" class="remove-from-cart-button text-red-500 hover:text-red-700 mr-2">
                                            &times;
                                        </button>
                                    </div>
                                </div>
                            `
                        }).join('')}
                        <div class="border-t pt-4 mt-4">
                            <p class="text-xl font-bold text-gray-800 text-right">الإجمالي: ${total.toFixed(2)} د.م.</p>
                        </div>
                        
                        <div class="flex justify-end gap-3 mt-6">
                            <button id="print-cart-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                                طباعة السلة
                            </button>
                            <button id="sell-items-button" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                                تم البيع
                            </button>
                            <button id="create-invoice-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                                إنشاء فاتورة
                            </button>
                        </div>
                    </div>
                `;
            }
            showGenericModal("السلة", cartContentHtml);
            // Attach event listeners for cart buttons
            document.querySelectorAll('.update-cart-quantity-button').forEach(button => {
                button.onclick = (e) => handleUpdateCartQuantity(e.target.dataset.productId, e.target.dataset.action === 'increase' ? 1 : -1);
            });
            document.querySelectorAll('.remove-from-cart-button').forEach(button => {
                button.onclick = (e) => handleRemoveFromCart(e.target.dataset.productId);
            });
            document.querySelectorAll('.cart-item-quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const productId = e.target.dataset.productId;
                    const newQuantity = parseInt(e.target.value, 10);
                    handleSetCartQuantity(productId, newQuantity, e.target);
                });
            });

            const printCartButton = document.getElementById('print-cart-button');
            if (printCartButton) printCartButton.onclick = handlePrintCart;
            const sellItemsButton = document.getElementById('sell-items-button');
            if (sellItemsButton) sellItemsButton.onclick = handleSellItems;
            const createInvoiceButton = document.getElementById('create-invoice-button');
            if (createInvoiceButton) createInvoiceButton.onclick = handleCreateInvoice;
        }

        /**
         * Renders the customer name input modal for invoice creation.
         */
        function renderCustomerNameModal() {
            const customerNameModalHtml = `
                <div class="space-y-4">
                    <label for="customer-name-input" class="block text-gray-700 font-medium">الاسم الكامل للعميل:</label>
                    <input
                        type="text"
                        id="customer-name-input"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        placeholder="أدخل اسم العميل"
                    />
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-invoice-creation-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="create-and-print-invoice-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            إنشاء وطباعة الفاتورة
                        </button>
                    </div>
                </div>
            `;
            showGenericModal("إدخال اسم العميل", customerNameModalHtml);

            document.getElementById('create-and-print-invoice-button').onclick = handleCreateAndPrintInvoice;
            document.getElementById('cancel-invoice-creation-button').onclick = hideGenericModal;
        }

        /**
         * Renders the add/edit product modal.
         */
        function renderAddEditProductModal() {
            const product = appData.products.find(p => p.id === appData.productToEditId);
            const isEditing = !!product;

            const categories = ['هواتف', 'سماعات', 'اكسسوارات', 'أخرى'];
            let categoryOptionsHtml = categories.map(cat => `<option value="${cat}" ${product && product.category === cat ? 'selected' : ''}>${cat}</option>`).join('');

            const isCustomCategory = product && !categories.includes(product.category);
            if (isEditing && isCustomCategory) {
                 categoryOptionsHtml = `<option value="${product.category}" selected>${product.category}</option>` + categoryOptionsHtml;
            }


            const productModalHtml = `
                <div class="space-y-4">
                    <div>
                        <label for="product-name-input" class="block text-gray-700 font-medium mb-1">الاسم:</label>
                        <input
                            type="text"
                            id="product-name-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${product ? product.name : ''}"
                            placeholder="اسم المنتج"
                        />
                    </div>
                    <div>
                        <label for="product-category-select" class="block text-gray-700 font-medium mb-1">الفئة:</label>
                        <select
                            id="product-category-select"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white"
                        >
                            <option value="">اختر فئة</option>
                            ${categoryOptionsHtml}
                        </select>
                        <input
                            type="text"
                            id="new-category-input"
                            class="w-full p-3 mt-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 ${!isCustomCategory && product && product.category !== 'أخرى' ? 'hidden' : ''}"
                            value="${isCustomCategory ? product.category : ''}"
                            placeholder="أدخل فئة جديدة"
                        />
                    </div>
                    <div>
                        <label for="product-price-input" class="block text-gray-700 font-medium mb-1">السعر (د.م.):</label>
                        <input
                            type="number"
                            id="product-price-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${product ? product.price : ''}"
                            placeholder="السعر"
                            min="0"
                            step="0.01"
                        />
                    </div>
                    <div>
                        <label for="product-cost-price-input" class="block text-gray-700 font-medium mb-1">سعر الجملة:</label>
                        <input
                            type="number"
                            id="product-cost-price-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${product ? (product.costPrice || '') : ''}"
                            placeholder="سعر التكلفة"
                            min="0"
                            step="0.01"
                        />
                    </div>
                    <div>
                        <label for="product-quantity-input" class="block text-gray-700 font-medium mb-1">الكمية:</label>
                        <input
                            type="number"
                            id="product-quantity-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${product ? product.quantity : ''}"
                            placeholder="الكمية"
                            min="0"
                        />
                    </div>
                    <div>
                        <label for="product-image-upload" class="block text-gray-700 font-medium mb-1">صورة المنتج:</label>
                        <input type="file" id="product-image-upload" class="hidden" accept="image/*">
                        <button id="select-image-button" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg flex items-center justify-center space-x-2 rtl:space-x-reverse border border-gray-300 hover:bg-gray-200 transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span>اختر صورة</span>
                        </button>
                        <div id="image-preview-container" class="mt-4 flex justify-center items-center h-40 border border-gray-300 rounded-lg bg-gray-50 overflow-hidden">
                            <img id="product-image-preview" src="${product ? product.imageUrl : 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة'}" alt="معاينة الصورة" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-product-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="save-product-button" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                            ${isEditing ? 'حفظ التعديلات' : 'إضافة المنتج'}
                        </button>
                    </div>
                </div>
            `;
            showGenericModal(isEditing ? "تعديل المنتج" : "إضافة منتج جديد", productModalHtml);

            // Get elements for image handling
            const imageUploadInput = document.getElementById('product-image-upload');
            const selectImageButton = document.getElementById('select-image-button');
            const imagePreview = document.getElementById('product-image-preview');

            // Set initial preview image
            if (product && product.imageUrl) {
                imagePreview.src = product.imageUrl;
            } else {
                imagePreview.src = 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة';
            }

            // Event listener for select image button click
            selectImageButton.onclick = () => imageUploadInput.click();

            // Event listener for file input change
            imageUploadInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result; // Set preview to Data URL
                        imagePreview.dataset.imageUrl = e.target.result; // Store Data URL for saving
                    };
                    reader.readAsDataURL(file); // Read file as Data URL (Base64)
                } else {
                    imagePreview.src = 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة';
                    imagePreview.dataset.imageUrl = ''; // Clear stored Data URL
                }
            };

            // Handle 'أخرى' category input visibility
            const categorySelect = document.getElementById('product-category-select');
            const newCategoryInput = document.getElementById('new-category-input');
        
            // Initial visibility check
            const isOtherSelected = categorySelect.value === 'أخرى';
            if (isOtherSelected || (isEditing && isCustomCategory)) {
                newCategoryInput.classList.remove('hidden');
            } else {
                newCategoryInput.classList.add('hidden');
            }
        
            // Pre-fill custom category when editing if 'أخرى' is pre-selected
            if (isEditing && isCustomCategory && isOtherSelected) {
                newCategoryInput.value = product.category;
            }

            categorySelect.onchange = () => {
                if (categorySelect.value === 'أخرى') {
                    newCategoryInput.classList.remove('hidden');
                } else {
                    newCategoryInput.classList.add('hidden');
                }
            };

            document.getElementById('save-product-button').onclick = () => {
                const name = document.getElementById('product-name-input').value.trim();
                let category = categorySelect.value;
                if (category === 'أخرى') {
                    category = newCategoryInput.value.trim();
                } else if (isEditing && isCustomCategory && category === "") {
                    // If editing a custom category and user didn't select a new one, retain old custom category
                    category = product.category;
                }

                const price = parseFloat(document.getElementById('product-price-input').value);
                const quantity = parseInt(document.getElementById('product-quantity-input').value);
                const imageUrl = imagePreview.dataset.imageUrl || product?.imageUrl || ''; // Get Data URL from preview or existing URL
                const costPrice = parseFloat(document.getElementById('product-cost-price-input').value);


                if (name && category && !isNaN(price) && !isNaN(quantity) && price >= 0 && quantity >= 0 && !isNaN(costPrice) && costPrice >= 0) {
                    const newProduct = {
                        id: isEditing ? product.id : `prod${Date.now()}`,
                        name,
                        category,
                        price,
                        costPrice: costPrice,
                        quantity,
                        imageUrl: imageUrl || 'https://placehold.co/150x150/EEEEEE/000000?text=لا+صورة'
                    };
                    handleSaveProduct(newProduct);
                } else {
                    addNotification('الرجاء إدخال جميع البيانات المطلوبة وبشكل صحيح.', 'error');
                }
            };
            document.getElementById('cancel-product-button').onclick = hideGenericModal;
        }

        /**
         * Renders the add/edit credit modal.
         */
        function renderAddEditCreditModal() {
            const credit = appData.credits.find(c => c.id === appData.creditToEditId);
            const isEditing = !!credit;

            const creditModalHtml = `
                <div class="space-y-4">
                    <div>
                        <label for="credit-customer-input" class="block text-gray-700 font-medium mb-1">الاسم الكامل للزبون:</label>
                        <input
                            type="text"
                            id="credit-customer-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${credit ? credit.customer : ''}"
                            placeholder="اسم الزبون"
                        />
                    </div>
                    <div>
                        <label for="credit-product-input" class="block text-gray-700 font-medium mb-1">المنتج الذي أخذه:</label>
                        <input
                            type="text"
                            id="credit-product-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${credit ? credit.product : ''}"
                            placeholder="اسم المنتج"
                        />
                    </div>
                    <div>
                        <label for="credit-amount-input" class="block text-gray-700 font-medium mb-1">الثمن (د.م.):</label>
                        <input
                            type="number"
                            id="credit-amount-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${credit ? credit.amount : ''}"
                            placeholder="الثمن"
                            min="0"
                            step="0.01"
                        />
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-credit-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="save-credit-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            ${isEditing ? 'حفظ التعديلات' : 'إضافة الكريدي'}
                        </button>
                    </div>
                </div>
            `;
            showGenericModal(isEditing ? "تعديل الكريدي" : "إضافة كريدي جديد", creditModalHtml);

            document.getElementById('save-credit-button').onclick = () => {
                const customer = document.getElementById('credit-customer-input').value.trim();
                const product = document.getElementById('credit-product-input').value.trim();
                const amount = parseFloat(document.getElementById('credit-amount-input').value);

                if (customer && product && !isNaN(amount) && amount >= 0) {
                    const newCredit = {
                        id: isEditing ? credit.id : `cred${Date.now()}`,
                        customer,
                        product,
                        amount,
                        date: isEditing ? credit.date : new Date(),
                        status: isEditing ? credit.status : 'unpaid'
                    };
                    handleSaveCredit(newCredit);
                } else {
                    addNotification('الرجاء إدخال جميع البيانات المطلوبة وبشكل صحيح.', 'error');
                }
            };
            document.getElementById('cancel-credit-button').onclick = hideGenericModal;
        }

        /**
         * NEW: Renders the add/edit supplier modal.
         */
        function renderAddEditSupplierModal() {
            const supplier = appData.suppliers.find(s => s.id === appData.supplierToEditId);
            const isEditing = !!supplier;

            const supplierModalHtml = `
                <div class="space-y-4">
                    <div>
                        <label for="supplier-name-input" class="block text-gray-700 font-medium mb-1">اسم المورد:</label>
                        <input
                            type="text"
                            id="supplier-name-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${supplier ? supplier.name : ''}"
                            placeholder="اسم المورد"
                            required
                        />
                    </div>
                    <div>
                        <label for="supplier-phone-input" class="block text-gray-700 font-medium mb-1">رقم الهاتف:</label>
                        <input
                            type="tel" 
                            id="supplier-phone-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${supplier ? supplier.phone : ''}"
                            placeholder="رقم الهاتف"
                            required
                        />
                    </div>
                    <div>
                        <label for="supplier-email-input" class="block text-gray-700 font-medium mb-1">البريد الإلكتروني (اختياري):</label>
                        <input
                            type="email"
                            id="supplier-email-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${supplier ? (supplier.email || '') : ''}"
                            placeholder="البريد الإلكتروني"
                        />
                    </div>
                    <div>
                        <label for="supplier-company-input" class="block text-gray-700 font-medium mb-1">اسم الشركة (اختياري):</label>
                        <input
                            type="text"
                            id="supplier-company-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${supplier ? (supplier.company || '') : ''}"
                            placeholder="اسم الشركة"
                        />
                    </div>
                    <div>
                        <label for="supplier-address-input" class="block text-gray-700 font-medium mb-1">العنوان:</label>
                        <textarea
                            id="supplier-address-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            rows="3"
                            placeholder="العنوان الكامل للمورد"
                        >${supplier ? (supplier.address || '') : ''}</textarea>
                    </div>
                    <div>
                        <label for="supplier-notes-input" class="block text-gray-700 font-medium mb-1">ملاحظات (اختياري):</label>
                        <textarea
                            id="supplier-notes-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            rows="3"
                            placeholder="أي ملاحظات إضافية"
                        >${supplier ? (supplier.notes || '') : ''}</textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-supplier-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">إلغاء</button>
                        <button id="save-supplier-button" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">${isEditing ? 'حفظ التعديلات' : 'إضافة المورد'}</button>
                    </div>
                </div>
            `;
            showGenericModal(isEditing ? "تعديل بيانات المورد" : "إضافة مورد جديد", supplierModalHtml);

            document.getElementById('save-supplier-button').onclick = () => {
                const name = document.getElementById('supplier-name-input').value.trim();
                const phone = document.getElementById('supplier-phone-input').value.trim();
                const email = document.getElementById('supplier-email-input').value.trim();
                const company = document.getElementById('supplier-company-input').value.trim();
                const address = document.getElementById('supplier-address-input').value.trim();
                const notes = document.getElementById('supplier-notes-input').value.trim();

                if (!name || !phone || !address) {
                    addNotification('الرجاء إدخال اسم المورد، رقم الهاتف، والعنوان.', 'error');
                    return;
                }
                if (!/^\d+$/.test(phone.replace(/[\s+()-]/g, ''))) {
                     addNotification('الرجاء إدخال رقم هاتف صحيح.', 'error');
                     return;
                }
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    addNotification('الرجاء إدخال بريد إلكتروني صحيح أو اتركه فارغاً.', 'error');
                    return;
                }

                const newSupplier = {
                    id: isEditing ? supplier.id : `supp${Date.now()}`,
                    name, phone,
                    email: email || null,
                    company: company || null,
                    address,
                    notes: notes || null
                };
                handleSaveSupplier(newSupplier);
            };
            document.getElementById('cancel-supplier-button').onclick = hideGenericModal;
        }

        /**
         * NEW: Renders the add/edit debt modal.
         */
        function renderAddEditDebtModal() {
            const debt = appData.debts.find(d => d.id === appData.debtToEditId);
            const isEditing = !!debt;

            // Helper to escape double quotes for HTML attribute values surrounded by double quotes
            const escapeAttrVal = (str) => {
                if (typeof str !== 'string') return '';
                return str.replace(/"/g, '&quot;');
            };

            // Helper to escape HTML special characters for content within tags like <textarea>
            const escapeHTMLContent = (str) => {
                if (typeof str !== 'string') return '';
                return str.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;');
            };

            const creditorValue = isEditing && debt ? debt.creditorName : ''; // Changed to empty string for new debts
            const amountValue = debt ? debt.amount : '';
            const dueDateValue = debt && debt.dueDate ? debt.dueDate.toISOString().slice(0,10) : '';
            const descriptionText = debt ? (debt.description || '') : '';

            const debtModalHtml = `
                <div class="space-y-4">
                    <div>
                        <label for="debt-creditor-name-input" class="block text-gray-700 font-medium mb-1">اسم الدائن:</label>
                        <input type="text" id="debt-creditor-name-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${escapeAttrVal(creditorValue)}" placeholder="مثال:اسم شركة، المورد فلان" required />
                    </div>
                    <div>
                        <label for="debt-amount-input" class="block text-gray-700 font-medium mb-1">المبلغ (د.م.):</label>
                        <input type="number" id="debt-amount-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${amountValue}" placeholder="0.00" min="0.01" step="0.01" required />
                    </div>
                    <div>
                        <label for="debt-due-date-input" class="block text-gray-700 font-medium mb-1">تاريخ الاستحقاق:</label>
                        <input type="date" id="debt-due-date-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${dueDateValue}" required />
                    </div>
                    <div>
                        <label for="debt-description-input" class="block text-gray-700 font-medium mb-1">الوصف (اختياري):</label>
                        <textarea id="debt-description-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="تفاصيل إضافية عن الدين">${escapeHTMLContent(descriptionText)}</textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-debt-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">إلغاء</button>
                        <button id="save-debt-button" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">${isEditing ? 'حفظ التعديلات' : 'إضافة الدين'}</button>
                    </div>
                </div>
            `;
            showGenericModal(isEditing ? "تعديل الدين" : "إضافة دين جديد", debtModalHtml);

            document.getElementById('save-debt-button').onclick = () => {
                const creditorName = document.getElementById('debt-creditor-name-input').value.trim();
                const amount = parseFloat(document.getElementById('debt-amount-input').value);
                const dueDateStr = document.getElementById('debt-due-date-input').value;
                const description = document.getElementById('debt-description-input').value.trim();

                if (!creditorName || isNaN(amount) || amount <= 0 || !dueDateStr) {
                    addNotification('الرجاء إدخال اسم الدائن، مبلغ صحيح، وتاريخ استحقاق.', 'error');
                    return;
                }

                const newDebt = {
                    id: isEditing ? debt.id : `debt${Date.now()}`,
                    creditorName,
                    amount,
                    dueDate: new Date(dueDateStr),
                    description: description || null, // Ensure description is null if empty, not ""
                    // If editing, debt.creationDate should already be a valid Date object or null due to parseDatesInLoadedData
                    // If debt.creationDate is null (e.g. from corrupted data that was loaded),
                    // new Date() will be used if we want to "fix" it upon edit, or we can propagate null.
                    // For now, let's assume debt.creationDate is valid if isEditing, or we create a new one.
                    // The saveData function will handle null dates before toISOString.
                    creationDate: isEditing ? debt.creationDate : new Date(),
                    status: isEditing ? debt.status : 'pending'
                };
                handleSaveDebt(newDebt);
            };
            document.getElementById('cancel-debt-button').onclick = hideGenericModal;
        }


        /**
         * Renders the notifications modal.
         */
        function renderNotificationsModal() {
            deleteOldNotifications(); // Delete old notifications before rendering
            let notificationsHtml = '';
            if (appData.notifications.length === 0) {
                notificationsHtml = '<p class="text-center text-gray-600">لا توجد إشعارات حالياً.</p>';
            } else {
                // Sort notifications by date, newest first
                const sortedNotifications = [...appData.notifications].sort((a, b) => b.date.getTime() - a.date.getTime());
                notificationsHtml = `
                    <ul class="space-y-3">
                        ${sortedNotifications.map(notif => `
                            <li class="p-3 bg-gray-50 rounded-lg shadow-sm ${!notif.read ? 'font-semibold' : ''}">
                                <p class="text-gray-800">${notif.message}</p>
                                <p class="text-sm text-gray-500 mt-1">${formatDateToFrench(notif.date)}</p>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }
            showGenericModal("الإشعارات", notificationsHtml);
            // Mark all notifications as read when the modal is opened
            markAllNotificationsAsRead();
        }

        /**
         * Renders the settings modal (placeholder for now).
         */
        function renderSettingsModal() {
            const backupRestoreHtml = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">إدارة البيانات</h3>
                    <p class="text-gray-700 mb-4">هنا يمكنك إجراء نسخ احتياطي لبياناتك أو استعادتها.</p>
                    <div class="flex gap-4">
                        <button id="modal-backup-button" class="flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200 shadow-md">
                            <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            نسخ احتياطي (تنزيل JSON)
                        </button>
                        <button id="modal-restore-button" class="flex items-center px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-200 shadow-md">
                            <svg class="w-5 h-5 ml-2 rtl:mr-2 rtl:ml-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v8m0-8V4m0 8H8m0 0h8m-1 8h.01M17 12h.01"></path></svg>
                            استعادة (تحميل JSON)
                        </button>
                    </div>
                </div>
            `;

            const printerSettingsHtml = `
                <hr class="my-6 border-gray-300">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">إعدادات الطابعة الحرارية</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="printer-interface-input" class="block text-sm font-medium text-gray-700">واجهة الطابعة:</label>
                            <input type="text" id="printer-interface-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="مثال: tcp://192.168.1.100:9100 أو usb:/dev/usb/lp0">
                        </div>
                        <div>
                            <label for="printer-type-select" class="block text-sm font-medium text-gray-700">نوع الطابعة:</label>
                            <select id="printer-type-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="EPSON">EPSON</option>
                                <option value="STAR">STAR</option>
                                <option value="DARUMA">DARUMA</option>
                                <option value="CUSTOM">CUSTOM</option>
                                <!-- يمكنك إضافة المزيد من الأنواع هنا، يجب أن تطابق مفاتيح printerTypeMap في main.js -->
                            </select>
                        </div>
                        <div>
                            <label for="printer-charset-select" class="block text-sm font-medium text-gray-700">مجموعة الأحرف:</label>
                            <select id="printer-charset-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="PC864_ARABIC">PC864 Arabic</option>
                                <option value="WPC1256_ARABIC">WPC1256 Arabic</option>
                                <option value="PC437_USA">PC437 USA</option>
                                <option value="UTF8">UTF-8 (اختبر جيداً)</option>
                                <!-- يمكنك إضافة المزيد من مجموعات الأحرف هنا، يجب أن تطابق مفاتيح characterSetMap في main.js -->
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-3 mt-4">
                            <button id="save-printer-config-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">حفظ الإعدادات</button>
                            <button id="test-printer-connection-button" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200">اختبار الاتصال</button>
                            <button id="discover-printers-button" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors duration-200">بحث عن الطابعات</button>
                        </div>
                        <div id="printer-status-message" class="mt-2 text-sm"></div>
                    </div>
                </div>
            `;

            showGenericModal("الإعدادات", backupRestoreHtml + printerSettingsHtml);

            // ملء حقول الطابعة بالإعدادات الحالية
            if (window.electronAPI && window.electronAPI.getPrinterSettings) {
                window.electronAPI.getPrinterSettings().then(settings => {
                    if (settings) {
                        const interfaceInput = document.getElementById('printer-interface-input');
                        const typeSelect = document.getElementById('printer-type-select');
                        const charsetSelect = document.getElementById('printer-charset-select');

                        if (interfaceInput) interfaceInput.value = settings.interface || 'tcp://192.168.0.100:9100';
                        if (typeSelect) typeSelect.value = settings.typeKey || 'EPSON';
                        if (charsetSelect) charsetSelect.value = settings.characterSetKey || 'PC864_ARABIC';
                    }
                }).catch(err => {
                    console.error("Error getting printer settings for modal:", err);
                    const statusDiv = document.getElementById('printer-status-message');
                    if (statusDiv) {
                        statusDiv.textContent = 'فشل تحميل إعدادات الطابعة الحالية.';
                        statusDiv.className = 'mt-2 text-sm text-red-600';
                    }
                });
            }

            document.getElementById('modal-backup-button').onclick = handleBackupData;
            document.getElementById('modal-restore-button').onclick = handleRestoreData;
            document.getElementById('save-printer-config-button').onclick = handleSavePrinterConfig;
            document.getElementById('test-printer-connection-button').onclick = handleTestPrinterConnection;
            document.getElementById('discover-printers-button').onclick = handleDiscoverPrinters;
        }

        /**
         * NEW: Renders the modal for entering/editing store name.
         */
        function renderStoreNameModal() {
            const modalTitle = "اسم وشعار المحل التجاري";
            const modalHtml = `
                <div class="space-y-4">
                    <div>
                        <label for="store-name-input" class="block text-gray-700 font-medium mb-1">اسم محلك التجاري:</label>
                        <input
                            type="text"
                            id="store-name-input"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${appData.storeName}"
                            placeholder="أدخل اسم محلك التجاري"
                        />
                    </div>
                    <div>
                        <label for="store-logo-upload-input" class="block text-gray-700 font-medium mb-1">شعار المحل (اختياري):</label>
                        <input type="file" id="store-logo-upload-input" class="hidden" accept="image/*">
                        <button type="button" id="select-store-logo-button" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg flex items-center justify-center space-x-2 rtl:space-x-reverse border border-gray-300 hover:bg-gray-200 transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span>اختر شعار</span>
                        </button>
                        <div class="mt-4 flex justify-center items-center h-32 w-32 mx-auto border border-gray-300 rounded-lg bg-gray-50 overflow-hidden">
                            <img id="store-logo-preview" src="${currentStoreLogoSrc || 'https://placehold.co/128x128/EEEEEE/333333?text=شعار'}" alt="معاينة الشعار" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-store-name-button" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="save-store-name-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            حفظ
                        </button>
                    </div>
                </div>
            `;
            showGenericModal(modalTitle, modalHtml);

            const logoUploadInput = document.getElementById('store-logo-upload-input');
            const selectLogoButton = document.getElementById('select-store-logo-button');
            const logoPreview = document.getElementById('store-logo-preview');

            // Set initial preview if a logo is already set for the session
            if (currentStoreLogoSrc) {
                logoPreview.src = currentStoreLogoSrc;
            }

            selectLogoButton.onclick = () => logoUploadInput.click();

            logoUploadInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoPreview.src = e.target.result; // Update preview
                    };
                    reader.readAsDataURL(file);
                } else {
                    // If no file selected or selection cancelled, revert to current session logo or placeholder
                    logoPreview.src = currentStoreLogoSrc || 'https://placehold.co/128x128/EEEEEE/333333?text=شعار';
                }
            };

            document.getElementById('save-store-name-button').onclick = () => {
                const storeName = document.getElementById('store-name-input').value.trim();
                const newLogoSrc = logoPreview.src;

                // Check if the preview src is the placeholder. If so, treat as no logo selected.
                if (newLogoSrc && !newLogoSrc.startsWith('https://placehold.co')) {
                    currentStoreLogoSrc = newLogoSrc; // A new logo was selected or an existing one kept
                } else {
                     // If placeholder is shown, or src is empty, means no logo or logo removed
                    currentStoreLogoSrc = null;
                }
                appData.storeLogo = currentStoreLogoSrc; // NEW: Save logo to appData
                handleSaveStoreName(storeName); // This will save the name and call updateStoreLogoDisplay
            };
            document.getElementById('cancel-store-name-button').onclick = hideGenericModal;
        }

        /**
         * NEW: Handles saving the store name.
         * The logo (currentStoreLogoSrc) is handled by the modal's save button click handler.
         * @param {string} name - The store name to save.
         */
        function handleSaveStoreName(name) {
            appData.storeName = name;
            addNotification(`تم حفظ اسم المحل التجاري: ${name}`, 'success');
            saveData(); // Save appData (which includes storeName but not the logo src)
            updateStoreLogoDisplay(); // Update the display of the logo
            hideGenericModal();
        }

        /**
         * Updates the category filter options in the inventory section
         * based on the categories present in appData.products.
         */
        function updateInventoryCategoryFilterOptions() {
            if (!inventoryCategoryFilter) return;

            const existingValue = inventoryCategoryFilter.value; // Preserve selected value if possible

            // Clear existing options (except the first "all" option)
            while (inventoryCategoryFilter.options.length > 1) {
                inventoryCategoryFilter.remove(1);
            }

            if (appData.products && appData.products.length > 0) {
                const categories = Array.from(new Set(appData.products.map(p => p.category).filter(cat => cat && cat.trim() !== '')));
                categories.sort((a, b) => a.localeCompare(b)); // Sort categories alphabetically

                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    inventoryCategoryFilter.appendChild(option);
                });
            }

            // Restore previously selected value if it still exists, otherwise default to "all"
            inventoryCategoryFilter.value = Array.from(inventoryCategoryFilter.options).some(opt => opt.value === existingValue) ? existingValue : 'all';
        }



        // --- Core Application Logic ---

        /**
         * Handles adding/updating a product.
         * @param {object} product - The product object to save.
         */
        function handleSaveProduct(product) {
            const isEditing = appData.products.some(p => p.id === product.id);
            let oldQuantity = Infinity;

            if (isEditing) {
                const existingProduct = appData.products.find(p => p.id === product.id);
                if (existingProduct) {
                    oldQuantity = existingProduct.quantity;
                }
            }

            if (isEditing) {
                // Update existing product
                appData.products = appData.products.map(p => (p.id === product.id ? product : p));
                addNotification(`تم تعديل المنتج: ${product.name}`, 'success');
            } else {
                // Add new product
                appData.products.push(product);
                addNotification(`تمت إضافة منتج جديد: ${product.name}`, 'success');
            }

            if (product.quantity !== oldQuantity) { // Only check if quantity actually changed
                checkAndNotifyLowStock(product.id, oldQuantity);
            }

            saveData();
            updateInventoryCategoryFilterOptions(); // Update category filter
            renderInventorySection(); // Re-render the inventory view
            renderLowStockSection(); // Update low stock section
            hideGenericModal(); // Close the modal
        }


        /**
         * NEW: Updates the display of the store logo in the header and sidebar.
         */
        function updateStoreLogoDisplay() {
            const headerButton = document.getElementById('store-profile-button');
            const sidebarImage = document.getElementById('sidebar-profile-image');

            if (headerButton) {
                if (currentStoreLogoSrc) {
                    headerButton.innerHTML = `<img src="${currentStoreLogoSrc}" alt="Store Logo" class="w-full h-full object-cover rounded-full">`;
                } else {
                    headerButton.innerHTML = originalHeaderProfileButtonSVG;
                }
            }

            if (sidebarImage) {
                sidebarImage.src = currentStoreLogoSrc || defaultSidebarProfileImageSrc;
            }
        }

        /**
         * Handles deleting a product after confirmation.
         * @param {string} productId - The ID of the product to delete.
         */
        function handleDeleteProduct(productId) {
            const productToDelete = appData.products.find(p => p.id === productId);
            if (!productToDelete) return;

            showConfirmationModal(`هل أنت متأكد أنك تريد حذف المنتج "${productToDelete.name}"؟ لا يمكن التراجع عن هذا الإجراء.`, () => {
                appData.products = appData.products.filter(p => p.id !== productId);
                addNotification(`تم حذف المنتج: ${productToDelete.name}`, 'success');
                saveData();
                updateInventoryCategoryFilterOptions(); // Update category filter
                renderInventorySection();
                renderLowStockSection(); // Update low stock section
            });
        }

        /**
         * Handles adding a product to the cart.
         * @param {string} productId - The ID of the product to add.
         */
        function handleAddToCart(productId) {
            const productIndex = appData.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            const product = appData.products[productIndex];
            if (product.quantity <= 0) {
                addNotification('لا يوجد مخزون كافٍ لهذا المنتج.', 'error');
                return;
            }
            const oldQty = product.quantity;
            // Decrease quantity in inventory
            appData.products[productIndex].quantity--;

            // Add/update in cart
            const cartItemIndex = appData.cartItems.findIndex(item => item.productId === productId);
            if (cartItemIndex !== -1) {
                appData.cartItems[cartItemIndex].quantity++;
            } else {
                appData.cartItems.push({ productId, quantity: 1 });
            }
            addNotification(`تمت إضافة منتج إلى السلة: ${appData.products[productIndex].name}`, 'info');
            checkAndNotifyLowStock(productId, oldQty);
            saveData();
            renderInventorySection(); // To update quantity displayed on card
            renderLowStockSection(); // Update low stock section
            renderTopBar(); // Update cart count
        }

        /**
         * Updates the quantity of a product in the cart.
         * @param {string} productId - The ID of the product.
         * @param {number} change - The amount to change the quantity by (+1 for increase, -1 for decrease).
         */
        function handleUpdateCartQuantity(productId, change) {
            const cartItemIndex = appData.cartItems.findIndex(item => item.productId === productId);
            if (cartItemIndex === -1) return;

            const productInInventory = appData.products.find(p => p.id === productId);
            if (!productInInventory) {
                showToast('خطأ: المنتج غير موجود في المخزون.', 'error');
                return;
            }

            const currentCartQuantity = appData.cartItems[cartItemIndex].quantity;
            const newCartQuantity = currentCartQuantity + change;

            if (newCartQuantity <= 0) {
                handleRemoveFromCart(productId); 
                return;
            }

            const oldQtyInventory = productInInventory.quantity;

            // Check if there's enough stock for the new quantity.
            // Only compare against remaining stock needed if increasing.
            if (change > 0 && productInInventory.quantity < change) {
                 addNotification(`لا يوجد مخزون كافٍ لإضافة الكمية المطلوبة للمنتج ${productInInventory.name}. المتوفر: ${productInInventory.quantity}`, 'warning');
                 return;
            }

            // Update inventory based on change
            appData.products = appData.products.map(p =>
                p.id === productId ? { ...p, quantity: p.quantity - change } : p
            );

            appData.cartItems[cartItemIndex].quantity = newCartQuantity;
            
            if (change > 0) { // Stock decreased
                checkAndNotifyLowStock(productId, oldQtyInventory);
            }
            saveData();
            renderCartModal(); // Re-render the cart modal
            renderTopBar(); // Update cart count
            renderInventorySection(); // Update inventory card quantities
            renderLowStockSection(); // Update low stock section
        }

        /**
         * Handles direct input change for cart item quantity.
         * @param {string} productId - The ID of the product.
         * @param {number} newQuantity - The new quantity from the input.
         * @param {HTMLElement} inputElement - The input element itself (to revert value if needed).
         */
        function handleSetCartQuantity(productId, newQuantity, inputElement) {
            const cartItemIndex = appData.cartItems.findIndex(item => item.productId === productId);
            if (cartItemIndex === -1) return; 

            const productIndex = appData.products.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showToast('خطأ: المنتج غير موجود في المخزون.', 'error');
                if (inputElement) inputElement.value = appData.cartItems[cartItemIndex].quantity; // Revert
                return;
            }

            const product = appData.products[productIndex];
            const oldCartQuantity = appData.cartItems[cartItemIndex].quantity;

            if (isNaN(newQuantity) || newQuantity < 0) { // Allow 0 for removal intent
                showToast('الرجاء إدخال كمية صالحة.', 'error');
                if (inputElement) inputElement.value = oldCartQuantity; // Revert
                return;
            }

            if (newQuantity === 0) {
                handleRemoveFromCart(productId); // This handles stock return and re-renders
                return;
            }

            if (newQuantity === oldCartQuantity) {
                return; // No change needed
            }

            const quantityDifferenceForInventory = newQuantity - oldCartQuantity;

            if (quantityDifferenceForInventory > 0) { // Increasing quantity in cart
                if (product.quantity < quantityDifferenceForInventory) {
                    addNotification(`لا يوجد مخزون كافٍ. المتوفر: ${product.quantity}`, 'warning');
                    if (inputElement) inputElement.value = oldCartQuantity; // Revert input
                    return;
                }
            }

            const oldInventoryQty = product.quantity;
            appData.products[productIndex].quantity -= quantityDifferenceForInventory;
            appData.cartItems[cartItemIndex].quantity = newQuantity;
            addNotification(`تم تعديل كمية المنتج ${product.name} في السلة.`, 'info');
            if (quantityDifferenceForInventory > 0) { checkAndNotifyLowStock(productId, oldInventoryQty); }

            saveData();
            renderCartModal(); 
            renderTopBar(); renderInventorySection(); renderLowStockSection();
        }
        /**
         * Removes a product from the cart and returns its quantity to inventory.
         * @param {string} productId - The ID of the product to remove.
         */
        function handleRemoveFromCart(productId) {
            const removedItem = appData.cartItems.find(item => item.productId === productId);
            if (!removedItem) return;

            // Return quantity to inventory
            appData.products = appData.products.map(p =>
                p.id === productId ? { ...p, quantity: p.quantity + removedItem.quantity } : p
            );

            appData.cartItems = appData.cartItems.filter(item => item.productId !== productId);
            addNotification(`تمت إزالة منتج من السلة: ${appData.products.find(p => p.id === productId)?.name}`, 'info');
            saveData();
            renderCartModal();
            renderTopBar();
            renderInventorySection();
            renderLowStockSection(); // Update low stock section
        }

        /**
         * Handles the "تم البيع" (Sold) button click.
         * Processes the sale without creating an invoice or credit.
         */
        function handleSellItems() {
            if (appData.cartItems.length === 0) {
                addNotification('السلة فارغة. لا يمكن إتمام عملية البيع.', 'warning');
                return;
            }

            showConfirmationModal('هل أنت متأكد أنك تريد إتمام عملية البيع؟ سيتم خصم المنتجات من المخزون.', () => {
                let totalSaleAmount = 0;
                appData.cartItems.forEach(item => {
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) {
                        totalSaleAmount += product.price * item.quantity;
                    }
                });

                // NEW: Create a record for direct sale
                const directSaleRecord = {
                    id: `ds-${Date.now()}`, // Unique ID for the direct sale
                    date: new Date().toISOString(),
                    items: JSON.parse(JSON.stringify(appData.cartItems.map(item => { // Deep copy items
                        const product = appData.products.find(p => p.id === item.productId);
                        return { productId: item.productId, name: product ? product.name : 'منتج غير معروف', quantity: item.quantity, price: product ? product.price : 0, costPrice: product ? (product.costPrice || 0) : 0 };
                    }))),
                    total: totalSaleAmount
                };
                appData.directSales.push(directSaleRecord);

                // Store details for potential undo - MOVED HERE
                appData.lastTransaction = {
                    type: 'sale',
                    transactionId: directSaleRecord.id, // Store ID of the direct sale for undo
                    soldItems: directSaleRecord.items, // Use items from the directSaleRecord
                    total: totalSaleAmount, // Now totalSaleAmount is calculated
                    transactionDate: directSaleRecord.date
                };

                // Daily sales update (only if an actual sale occurred)
                if (totalSaleAmount > 0) {
                     updateDailySales(totalSaleAmount); // This updates appData.dailySales.hourlySales

                     // NEW: Update monthly and weekly sales data for direct sales
                     const saleDate = new Date();
                     const saleMonthYear = saleDate.getFullYear() + '-' + (saleDate.getMonth() + 1).toString().padStart(2, '0');
                     appData.monthlySalesData[saleMonthYear] = (appData.monthlySalesData[saleMonthYear] || 0) + totalSaleAmount;

                     const saleDateString = saleDate.toISOString().slice(0, 10);
                     appData.weeklySalesData[saleDateString] = (appData.weeklySalesData[saleDateString] || 0) + totalSaleAmount;
                }

                // Clear cart (quantities already adjusted in handleUpdateCartQuantity or handleAddToCart)
                appData.cartItems = [];
                addNotification(`تم إتمام عملية البيع بنجاح بمبلغ ${totalSaleAmount.toFixed(2)} د.م.`, 'success');
                saveData(); // Save data *after* all updates
                hideGenericModal(); // Close cart modal
                renderTopBar(); // Update cart count (becomes 0)
                updateUndoResetButtonsState(); // Update button states
                // No need to call renderInventorySection or renderLowStockSection here as renderContent will handle it if needed, or reports section will be rendered.
                if (appData.activeTab === 'reports') {
                    renderReportsSection(); // Re-render reports to update charts
                }
            });
        }

        /**
         * Initiates invoice creation by showing customer name modal.
         */
        function handleCreateInvoice() {
            if (appData.cartItems.length === 0) {
                addNotification('السلة فارغة. لا يمكن إنشاء فاتورة.', 'warning');
                return;
            }
            hideGenericModal(); // Close cart modal
            renderCustomerNameModal();
        }

        function handleCreateAndPrintInvoice() {
            // التأكد من أن السلة ليست فارغة قبل المتابعة
            if (appData.cartItems.length === 0) {
                addNotification('السلة فارغة. لا يمكن إنشاء وطباعة الفاتورة.', 'warning');
                hideGenericModal(); // إغلاق نافذة اسم العميل
                return;
            }
            const customerNameInput = document.getElementById('customer-name-input');
            const customerName = customerNameInput ? customerNameInput.value.trim() : "زبون"; // Default if input not found or empty

            const newInvoiceItems = appData.cartItems.map(item => {
                const product = appData.products.find(p => p.id === item.productId);
                return { productId: item.productId, name: product ? product.name : 'منتج غير معروف', quantity: item.quantity, price: product ? product.price : 0, costPrice: product ? (product.costPrice || 0) : 0 };
            });

            const totalInvoiceAmount = newInvoiceItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            const newInvoice = {
                id: `inv${Date.now()}`,
                invoiceNumber: `FAC-${Date.now().toString().slice(-10)}`, // Simple unique ID
                customerName: customerName || "زبون", // Use "زبون" if name is empty
                date: new Date(),
                total: totalInvoiceAmount,
                items: newInvoiceItems
            };

            // Store details for potential undo
            appData.lastTransaction = {
                type: 'invoice',
                soldItems: JSON.parse(JSON.stringify(newInvoiceItems)),
                total: totalInvoiceAmount,
                invoiceId: newInvoice.id,
                customerName: newInvoice.customerName,
                transactionDate: new Date(newInvoice.date).toISOString()
            };

            appData.invoices.push(newInvoice);

            // Update monthly and weekly sales data based on this invoice
            const invoiceDate = new Date(newInvoice.date);
            const invoiceMonthYear = invoiceDate.getFullYear() + '-' + (invoiceDate.getMonth() + 1).toString().padStart(2, '0');
            appData.monthlySalesData[invoiceMonthYear] = (appData.monthlySalesData[invoiceMonthYear] || 0) + totalInvoiceAmount;

            const invoiceDateString = invoiceDate.toISOString().slice(0, 10);
            appData.weeklySalesData[invoiceDateString] = (appData.weeklySalesData[invoiceDateString] || 0) + totalInvoiceAmount;

            // Daily sales update
            updateDailySales(totalInvoiceAmount);

            appData.cartItems = []; // Clear cart after creating invoice
            addNotification(`تم إنشاء فاتورة جديدة للعميل ${newInvoice.customerName}`, 'success');
            saveData();
            hideGenericModal(); // Close customer name modal
            renderInvoicesSection(); // Re-render invoices list
            renderTopBar(); // Update cart count (becomes 0)
            updateUndoResetButtonsState();

            if (appData.activeTab === 'reports') {
                renderReportsSection(); // Re-render reports to update charts
            }
            // Automatically print the newly created invoice
            handlePrintInvoice(newInvoice.id);
        }

        /**
         * Handles adding/updating a credit.
         * @param {object} credit - The credit object to save.
         */
        function handleSaveCredit(credit) {
            if (appData.credits.some(c => c.id === credit.id)) {
                // Update existing credit
                appData.credits = appData.credits.map(c => (c.id === credit.id ? credit : c));
                addNotification(`تم تعديل الكريدي للعميل: ${credit.customer}`, 'success');
            } else {
                // Add new credit
                appData.credits.push(credit);
                addNotification(`تمت إضافة كريدي جديد للعميل: ${credit.customer}`, 'success');
            }
            saveData();
            renderCreditSection(); // Re-render the credit view
            hideGenericModal(); // Close the modal
        }

        /**
         * Marks a credit as paid.
         * @param {string} creditId - The ID of the credit to mark as paid.
         */
        function handleMarkCreditAsPaid(creditId) {
            appData.credits = appData.credits.map(c =>
                c.id === creditId ? { ...c, status: 'paid' } : c
            );
            const paidCredit = appData.credits.find(c => c.id === creditId);
            addNotification(`تم دفع كريدي العميل: ${paidCredit?.customer}`, 'success');
            saveData();
            renderCreditSection(); // Re-render the credit view
        }

        /**
         * NEW: Handles adding/updating a supplier.
         * @param {object} supplier - The supplier object to save.
         */
        function handleSaveSupplier(supplier) {
            const isEditing = appData.suppliers.some(s => s.id === supplier.id);
            if (isEditing) {
                appData.suppliers = appData.suppliers.map(s => (s.id === supplier.id ? supplier : s));
                addNotification(`تم تعديل بيانات المورد: ${supplier.name}`, 'success');
            } else {
                appData.suppliers.push(supplier);
                addNotification(`تمت إضافة مورد جديد: ${supplier.name}`, 'success');
            }
            saveData();
            renderSuppliersSection();
            hideGenericModal();
        }

        /**
         * NEW: Handles deleting a supplier after confirmation.
         * @param {string} supplierId - The ID of the supplier to delete.
         */
        function handleDeleteSupplier(supplierId) {
            const supplierToDelete = appData.suppliers.find(s => s.id === supplierId);
            if (!supplierToDelete) return;

            showConfirmationModal(`هل أنت متأكد أنك تريد حذف المورد "${supplierToDelete.name}"؟ لا يمكن التراجع عن هذا الإجراء.`, () => {
                appData.suppliers = appData.suppliers.filter(s => s.id !== supplierId);
                addNotification(`تم حذف المورد: ${supplierToDelete.name}`, 'success');
                saveData();
                renderSuppliersSection();
            });
        }

        /**
         * NEW: Handles adding/updating a debt.
         * @param {object} debt - The debt object to save.
         */
        function handleSaveDebt(debt) {
            const isEditing = appData.debts.some(d => d.id === debt.id);
            if (isEditing) {
                appData.debts = appData.debts.map(d => (d.id === debt.id ? debt : d));
                addNotification(`تم تعديل الدين للدائن: ${debt.creditorName}`, 'success');
            } else {
                appData.debts.push(debt);
                addNotification(`تمت إضافة دين جديد للدائن: ${debt.creditorName}`, 'success');
            }
            saveData();
            renderDebtsSection(); // This might throw if sorting isn't robust
            hideGenericModal();
        }

        /**
         * NEW: Marks a debt as paid.
         * @param {string} debtId - The ID of the debt to mark as paid.
         */
        function handleMarkDebtAsPaid(debtId) {
            appData.debts = appData.debts.map(d =>
                d.id === debtId ? { ...d, status: 'paid' } : d
            );
            const paidDebt = appData.debts.find(d => d.id === debtId);
            addNotification(`تم تحديد دين الدائن "${paidDebt?.creditorName}" كمدفوع.`, 'success');
            saveData();
            renderDebtsSection();
        }

        /**
         * Handles deleting a credit after confirmation.
         * @param {string} creditId - The ID of the credit to delete.
         */
        function handleDeleteCredit(creditId) {
            const creditToDelete = appData.credits.find(c => c.id === creditId);
            if (!creditToDelete) return;

            showConfirmationModal(`هل أنت متأكد أنك تريد حذف كريدي العميل "${creditToDelete.customer}"؟ لا يمكن التراجع عن هذا الإجراء.`, () => {
                appData.credits = appData.credits.filter(c => c.id !== creditId);
                addNotification(`تم حذف كريدي العميل: ${creditToDelete.customer}`, 'success');
                saveData();
                renderCreditSection();
            });
        }

        /**
         * Handles deleting an invoice after confirmation.
         * @param {string} invoiceId - The ID of the invoice to delete.
         */
        function handleDeleteInvoice(invoiceId) {
            const invoiceToDelete = appData.invoices.find(inv => inv.id === invoiceId);
            if (!invoiceToDelete) return;

            showConfirmationModal(`هل أنت متأكد أنك تريد حذف الفاتورة رقم "${invoiceToDelete.invoiceNumber}"؟ لا يمكن التراجع عن هذا الإجراء.`, () => {
                appData.invoices = appData.invoices.filter(inv => inv.id !== invoiceId);
                addNotification(`تم حذف الفاتورة رقم: ${invoiceToDelete.invoiceNumber}`, 'success');
                saveData();
                renderInvoicesSection();
            });
        }

        /**
         * NEW: Handles deleting a debt after confirmation.
         * @param {string} debtId - The ID of the debt to delete.
         */
        function handleDeleteDebt(debtId) {
            const debtToDelete = appData.debts.find(d => d.id === debtId);
            if (!debtToDelete) return;

            showConfirmationModal(`هل أنت متأكد أنك تريد حذف الدين للدائن "${debtToDelete.creditorName}" بمبلغ ${debtToDelete.amount.toFixed(2)} د.م؟`, () => {
                appData.debts = appData.debts.filter(d => d.id !== debtId);
                addNotification(`تم حذف الدين للدائن: ${debtToDelete.creditorName}`, 'success');
                saveData();
                renderDebtsSection();
            });
        }

        /**
         * Handles the "Undo Last Transaction" button click.
         * Reverts the last sale or invoice creation.
         */
        function handleUndoLastTransaction() {
            if (!appData.lastTransaction) {
                console.log("No last transaction to undo.");
                addNotification('لا توجد عملية أخيرة للتراجع عنها.', 'warning');
                return;
            }

            const { type, soldItems, total, invoiceId, customerName, transactionDate: txDateISO } = appData.lastTransaction;
            const transactionDate = new Date(txDateISO);

            console.log("Undoing transaction:", appData.lastTransaction);
            // 1. Restore product quantities
            soldItems.forEach(soldItem => {
                const productIndex = appData.products.findIndex(p => p.id === soldItem.productId);
                if (productIndex !== -1) {
                    appData.products[productIndex].quantity += soldItem.quantity;
                } else {
                    console.warn(`Product ID ${soldItem.productId} not found during undo. Quantity not restored.`);
                }
            });

            // 2. Reverse sales data updates
            const currentHour = transactionDate.getHours();
            const currentDayString = transactionDate.toISOString().slice(0, 10);

            if (appData.dailySales.date === currentDayString) { // Check if the undo is for the current day's sales log
                appData.dailySales.hourlySales[currentHour] = Math.max(0, appData.dailySales.hourlySales[currentHour] - total);
            }

            const monthYearKey = transactionDate.getFullYear() + '-' + (transactionDate.getMonth() + 1).toString().padStart(2, '0');
            if (appData.monthlySalesData[monthYearKey]) {
                appData.monthlySalesData[monthYearKey] = Math.max(0, appData.monthlySalesData[monthYearKey] - total);
            }

            if (appData.weeklySalesData[currentDayString]) {
                appData.weeklySalesData[currentDayString] = Math.max(0, appData.weeklySalesData[currentDayString] - total);
            }

            // 3. Remove the transaction record
            if (type === 'invoice' && invoiceId) {
                appData.invoices = appData.invoices.filter(inv => inv.id !== invoiceId);
            } else if (type === 'sale' && appData.lastTransaction.transactionId) { // NEW: Handle direct sale undo
                appData.directSales = appData.directSales.filter(sale => sale.id !== appData.lastTransaction.transactionId);
            }

            let undoMessage = '';
            if (type === 'invoice') {
                undoMessage = `تم التراجع عن إنشاء فاتورة للعميل ${customerName} (رقم: ${invoiceId ? invoiceId.slice(-10) : 'غير معروف'}).`;
            } else if (type === 'sale') {
                undoMessage = 'تم التراجع عن عملية البيع المباشرة الأخيرة.';
            } else {
                undoMessage = 'تم التراجع عن العملية الأخيرة.';
            }
            addNotification(undoMessage, 'success');

            appData.lastTransaction = null; // Clear the last transaction
            saveData();
            renderContent();
        }

        function handleResetCartAndStock() {
            if (appData.cartItems.length === 0) {
                addNotification('السلة فارغة بالفعل.', 'info');
                return;
            }
            showConfirmationModal('هل أنت متأكد أنك تريد إفراغ السلة وإرجاع الكميات للمخزون؟', () => {
                appData.cartItems.forEach(cartItem => {
                    const productIndex = appData.products.findIndex(p => p.id === cartItem.productId);
                    if (productIndex !== -1) appData.products[productIndex].quantity += cartItem.quantity;
                });
                appData.cartItems = [];
                addNotification('تم إفراغ السلة وإرجاع الكميات إلى المخزون.', 'success');
                saveData();
                renderContent(); // This will call renderTopBar which calls updateUndoResetButtonsState
                if (!genericModal.classList.contains('hidden') && genericModalTitle.textContent === 'السلة') renderCartModal();
            });
        }

        // --- Chart Drawing Functions ---

        /**
         * Helper to draw a bar chart on a canvas.
         * @param {HTMLCanvasElement} canvas - The canvas element.
         * @param {string[]} labels - Array of labels for x-axis.
         * @param {number[]} data - Array of data values for bars.
         * @param {string} title - Chart title.
         * @param {string[]|string} barColor - Color(s) of the bars. Can be an array for individual bar colors.
         */
        function drawBarChart(canvas, labels, data, title, barColor) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            // Set canvas dimensions to fit parent
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight; 

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 50; // Increased padding for clarity
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;

            const maxValue = data.length > 0 ? Math.max(...data, 0) : 1000; // Ensure a default max if no data
            const effectiveMaxValue = maxValue === 0 ? (data.length > 0 ? Math.max(...data.map(d => Math.abs(d)), 10) : 1000) : maxValue; // Handle all zero or negative data for scale
            const scaleY = chartHeight / effectiveMaxValue;

            const numBars = labels.length;
            let barWidth, gap;
            if (numBars > 0) {
                const totalGapSpaceRatio = numBars > 1 ? 0.2 : 0.5; // More gap for single bar
                const totalGapSpace = chartWidth * totalGapSpaceRatio; 
                barWidth = (chartWidth - totalGapSpace) / numBars;
                gap = totalGapSpace / (numBars + 1);
            } else {
                barWidth = 0;
                gap = chartWidth / 2; // Center if no bars (though usually won't draw)
            }


            ctx.fillStyle = '#333'; // Default text color
            ctx.strokeStyle = '#ccc'; // Axis line color
            ctx.lineWidth = 1;      // Axis line width

            // Draw Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();

            // Draw X-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Grid line style
            ctx.strokeStyle = '#e0e0e0'; // Lighter gray for grid lines
            ctx.lineWidth = 0.5;

            // Y-axis values and Horizontal Grid Lines
            const numYLabels = 5;
            ctx.font = '10px Inter'; // Smaller font for axis labels
            ctx.textAlign = 'right'; // Align Y labels to the right of the axis
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= numYLabels; i++) {
                const yValue = (effectiveMaxValue / numYLabels) * i;
                const yPos = canvas.height - padding - (yValue * scaleY);
                ctx.fillStyle = '#555';
                ctx.fillText(yValue.toFixed(0), padding - 10, yPos);

                // Horizontal grid line
                if (i > 0 && i < numYLabels) { // Avoid drawing on X-axis or top padding line
                    ctx.beginPath();
                    ctx.moveTo(padding + 1, yPos); // Start slightly off Y-axis
                    ctx.lineTo(canvas.width - padding, yPos);
                    ctx.stroke();
                } else if (i === numYLabels && effectiveMaxValue > 0) { // Topmost grid line if not at padding
                     ctx.beginPath();
                    ctx.moveTo(padding + 1, yPos);
                    ctx.lineTo(canvas.width - padding, yPos);
                    ctx.stroke();
                }
            }

            // Draw bars and X-axis labels
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top'; // Align X labels to the top (below axis)
            for (let i = 0; i < data.length; i++) {
                const currentBarColor = Array.isArray(barColor) ? barColor[i] : barColor;
                ctx.fillStyle = currentBarColor;
                const barHeight = data[i] * scaleY;
                const x = padding + gap + i * (barWidth + gap);
                const y = canvas.height - padding - barHeight;

                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw label below the bar
                ctx.fillStyle = '#333';
                ctx.fillText(labels[i], x + barWidth / 2, canvas.height - padding + 10);
            }

            // Chart Title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Inter'; // Bolder title
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(title, canvas.width / 2, padding - 10); // Position title above chart
        }

        /**
         * Helper to draw a line chart on a canvas with area fill.
         * @param {HTMLCanvasElement} canvas - The canvas element.
         * @param {string[]} labels - Array of labels for x-axis.
         * @param {number[]} data - Array of data values for points.
         * @param {string} title - Chart title.
         * @param {string} lineColor - Color of the line.
         * @param {string} fillColor1 - Start color for gradient fill.
         * @param {string} fillColor2 - End color for gradient fill.
         */
        function drawAreaChart(canvas, labels, data, title, lineColor, fillColor1, fillColor2) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            // Set canvas dimensions to fit parent
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 50; // Increased padding for clarity
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;

            const maxValue = data.length > 0 ? Math.max(...data, 0) : 1000;
            const effectiveMaxValue = maxValue === 0 ? (data.length > 0 ? 10 : 1000) : maxValue; // Simplified for area
            const scaleY = chartHeight / effectiveMaxValue;

            const pointStep = labels.length > 1 ? chartWidth / (labels.length - 1) : chartWidth; // Handle single point

            ctx.fillStyle = '#333'; // Default text color
            ctx.strokeStyle = '#ccc'; // Axis line color
            ctx.lineWidth = 1;      // Axis line width

            // Draw Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();

            // Draw X-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Grid line style
            ctx.strokeStyle = '#e0e0e0'; // Lighter gray for grid lines
            ctx.lineWidth = 0.5;

            // Y-axis values and Horizontal Grid Lines
            const numYLabels = 5;
            ctx.font = '10px Inter'; // Smaller font for axis labels
            ctx.textAlign = 'right'; // Align Y labels to the right of the axis
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= numYLabels; i++) {
                const yValue = (effectiveMaxValue / numYLabels) * i;
                const yPos = canvas.height - padding - (yValue * scaleY);
                ctx.fillStyle = '#555';
                ctx.fillText(yValue.toFixed(0), padding - 10, yPos);

                // Horizontal grid line
                if (i > 0 && i < numYLabels) { // Avoid drawing on X-axis or top padding line
                    ctx.beginPath();
                    ctx.moveTo(padding + 1, yPos);
                    ctx.lineTo(canvas.width - padding, yPos);
                    ctx.stroke();
                } else if (i === numYLabels && effectiveMaxValue > 0) { // Topmost grid line
                     ctx.beginPath();
                    ctx.moveTo(padding + 1, yPos);
                    ctx.lineTo(canvas.width - padding, yPos);
                    ctx.stroke();
                }
            }

            // X-axis labels and Vertical Grid Lines
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top'; // Align X labels to the top (below axis)
            for (let i = 0; i < labels.length; i++) {
                const x = padding + i * pointStep;
                ctx.fillStyle = '#555';
                ctx.fillText(labels[i], x, canvas.height - padding + 10);

                // Vertical grid line
                if (labels.length > 1 && i > 0 && i < labels.length) { // Don't draw on Y-axis or last point if it aligns with edge
                    ctx.beginPath();
                    ctx.moveTo(x, padding + 1); // Start slightly off top padding
                    ctx.lineTo(x, canvas.height - padding -1); // End slightly off X-axis
                    ctx.stroke();
                }
            }

            // Create gradient for fill
            const gradient = ctx.createLinearGradient(0, padding, 0, canvas.height - padding);
            gradient.addColorStop(0, fillColor1);
            gradient.addColorStop(1, fillColor2);

            // Draw area
            ctx.beginPath();
            const firstX = labels.length > 0 ? padding + 0 * pointStep : padding;
            ctx.moveTo(firstX, canvas.height - padding); // Start at bottom-left of chart area
            for (let i = 0; i < data.length; i++) {
                const x = padding + i * pointStep;
                const y = canvas.height - padding - (data[i] * scaleY);
                ctx.lineTo(x, y);
            }
            if (data.length > 0) {
                const lastX = padding + (labels.length - 1) * pointStep;
                ctx.lineTo(lastX, canvas.height - padding); // End at bottom-right of chart area
            } else { // If no data, ensure path is closed to avoid fill issues
                ctx.lineTo(firstX, canvas.height - padding);
            }
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            // Draw line on top
            if (data.length > 0) {
                ctx.beginPath();
                ctx.strokeStyle = lineColor;
                ctx.lineWidth = 2;
                for (let i = 0; i < data.length; i++) {
                    const x = padding + i * pointStep;
                    const y = canvas.height - padding - (data[i] * scaleY);
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Draw points
                ctx.fillStyle = lineColor; // Use line color for points for consistency
                for (let i = 0; i < data.length; i++) {
                    const x = padding + i * pointStep;
                    const y = canvas.height - padding - (data[i] * scaleY);
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Chart Title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Inter'; // Bolder title
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(title, canvas.width / 2, padding - 10); // Position title above chart
        }

        function drawMonthlySalesChart() {
            // appData.monthlySalesData is already in the format { 'YYYY-MM': total_sales }
            // Get data for the last 12 months
            const labels = [];
            const data = [];
            const now = new Date();
            for (let i = 11; i >= 0; i--) { // Loop for last 12 months
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = d.toLocaleString('ar', { month: 'short' }); // Arabic month name
                labels.push(`${monthName}`); // Month name
                const key = d.getFullYear() + '-' + (d.getMonth() + 1).toString().padStart(2, '0'); // YYYY-MM
                data.push(appData.monthlySalesData[key] || 0);
            }

            drawBarChart(monthlySalesChartCanvas, labels, data, 'إجمالي المبيعات الشهرية', '#2563eb'); // Updated title and color
        }

        function drawWeeklySalesChart() {
            // appData.weeklySalesData is { 'YYYY-MM-DD': total_sales }
            const labels = [];
            const data = [];
            const today = new Date();
            // Monday is 1, Sunday is 0. To start from Monday, calculate offset.
            const dayNamesOrdered = ['الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد'];

            // Calculate the date of the current Monday
            const d = new Date(today);
            const currentDayIndex = d.getDay(); // 0 for Sunday, 1 for Monday...
            const diff = (currentDayIndex === 0) ? 6 : (currentDayIndex - 1); // Days to subtract to get to Monday
            d.setDate(d.getDate() - diff); // Set to this week's Monday

            for (let i = 0; i < 7; i++) { // Loop for 7 days, starting from Monday
                const currentDate = new Date(d);
                currentDate.setDate(d.getDate() + i); // Increment by i days
                
                const dateString = currentDate.toISOString().slice(0, 10); // YYYY-MM-DD
                labels.push(dayNamesOrdered[i]); // Use the ordered day names
                data.push(appData.weeklySalesData[dateString] || 0);
            }
            
            drawAreaChart(weeklySalesChartCanvas, labels, data, 'إجمالي المبيعات الأسبوعية', '#20c997', 'rgba(32, 201, 151, 0.4)', 'rgba(32, 201, 151, 0.05)'); // Updated title and colors
        }

        function drawDailySalesChart() {
            const labels = [];
            const data = [];

            // Daily chart only for hours 8 AM to 12 AM (23)
            for (let hour = 8; hour <= 23; hour++) {
                labels.push(`${hour}:00`);
                data.push(appData.dailySales.hourlySales[hour] || 0);
            }
            drawBarChart(dailySalesChartCanvas, labels, data, 'المدخول اليومي (حسب الساعة)', '#FFD700');
        }

        /**
         * NEW: Draws the profit analysis chart.
         * Colors bars based on profit margin.
         */
        function drawProfitAnalysisChart() {
            // 1. Calculate sales count for each product
            const productSalesCount = {};
            appData.invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    // Use productId for more accurate tracking if names can change or are not unique
                    const product = appData.products.find(p => p.id === item.productId);
                    if (product) { // Ensure product exists
                        productSalesCount[product.id] = (productSalesCount[product.id] || 0) + item.quantity;
                    }
                });
            });

            // 2. Sort products by sales count and take top 10
            const sortedProductIdsBySales = Object.entries(productSalesCount)
                .sort(([, a], [, b]) => b - a) // Sort by count descending
                .slice(0, 10) // Take top 10
                .map(([productId]) => productId);

            // 3. Get profit data for these top 10 products
            const profitData = {};
            sortedProductIdsBySales.forEach(productId => {
                const product = appData.products.find(p => p.id === productId);
                if (product) {
                    const costPrice = parseFloat(product.costPrice) || 0;
                    const profit = product.price - costPrice;
                    let color;
                    if (profit < 0) color = 'red';
                    else if (product.price > 0 && (profit / product.price) < 0.20) color = 'yellow';
                    else color = 'green';
                    profitData[product.name] = { profit, color }; // Use product name for label
                }
            });

            const labels = Object.keys(profitData); // These are now the names of the top 10 selling products
            const data = labels.map(label => profitData[label].profit);
            const colors = labels.map(label => profitData[label].color);

            if (labels.length === 0) {
                const ctx = profitAnalysisChartCanvas.getContext('2d');
                ctx.clearRect(0, 0, profitAnalysisChartCanvas.width, profitAnalysisChartCanvas.height);
                ctx.fillStyle = '#333';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('لا توجد بيانات ربح للمنتجات.', profitAnalysisChartCanvas.width / 2, profitAnalysisChartCanvas.height / 2);
                return;
            }

            drawBarChart(profitAnalysisChartCanvas, labels, data, 'تحليل الربح للمنتجات', colors);
        }

        // --- Printing Functions ---

        function handlePrintProducts() {
            let productsToPrint = [...appData.products];
            // Apply current search and sort filters to printed output
            appData.searchTerm = searchInput.value.trim(); // Get current search term from input
            if (appData.searchTerm) {
                productsToPrint = productsToPrint.filter(p =>
                    p.name.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    p.category.toLowerCase().includes(appData.searchTerm.toLowerCase())
                );
            }
            const sortOption = inventorySortSelect.value;
            switch (sortOption) {
                case 'name-asc': productsToPrint.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': productsToPrint.sort((a, b) => b.name.localeCompare(a.name)); break;
                case 'price-asc': productsToPrint.sort((a, b) => a.price - b.price); break;
                case 'price-desc': productsToPrint.sort((a, b) => b.price - a.price); break;
                case 'quantity-asc': productsToPrint.sort((a, b) => a.quantity - b.quantity); break;
                case 'quantity-desc': productsToPrint.sort((a, b) => b.quantity - a.quantity); break;
                default: break;
            }

            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `سجل المنتجات - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">سجل المنتجات - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الاسم</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الفئة</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الكمية</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">السعر (د.م.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsToPrint.map(p => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${p.name}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${p.category}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${p.quantity}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${p.price.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }

        /**
         * NEW: Handles printing the list of debts.
         */
        function handlePrintDebtsList() {
            let debtsToPrint = [...appData.debts];
            // Apply current filters and sorting from UI
            // (Similar logic as handlePrintCredits or handlePrintSuppliersList)
            // For brevity, this example doesn't re-implement all filter/sort logic here,
            // but in a full app, you'd apply the same filters as renderDebtsSection.

            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `سجل الديون - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">سجل الديون - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الدائن</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">المبلغ (د.م.)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">تاريخ الاستحقاق</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${debtsToPrint.map(d => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${d.creditorName}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${d.amount.toFixed(2)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatDateOnly(d.dueDate)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${d.status === 'paid' ? 'green' : 'red'}; font-weight: bold;">${d.status === 'paid' ? 'تم الأداء' : 'باقي'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }

        function handlePrintCredits() {
            let creditsToPrint = [...appData.credits];
            // Apply current search, status filter, and sort filters
            appData.searchTerm = searchInput.value.trim(); // Get current search term from input
            if (appData.searchTerm) {
                creditsToPrint = creditsToPrint.filter(c =>
                    c.customer.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    c.product.toLowerCase().includes(appData.searchTerm.toLowerCase())
                );
            }
            const filterStatus = creditStatusFilter.value;
            if (filterStatus !== 'all') {
                creditsToPrint = creditsToPrint.filter(c => c.status === filterStatus);
            }
            const sortOption = creditSortSelect.value;
            switch (sortOption) {
                case 'date-desc': creditsToPrint.sort((a, b) => b.date.getTime() - a.date.getTime()); break;
                case 'date-asc': creditsToPrint.sort((a, b) => a.date.getTime() - b.date.getTime()); break;
                case 'name-asc': creditsToPrint.sort((a, b) => a.customer.localeCompare(b.customer)); break;
                case 'name-desc': creditsToPrint.sort((a, b) => b.customer.localeCompare(a.customer)); break;
                default: break;
            }

            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `سجل الكريديات - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">سجل الكريديات - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الزبون</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">المنتج</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الثمن (د.م.)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">التاريخ</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${creditsToPrint.map(c => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${c.customer}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${c.product}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${c.amount.toFixed(2)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatDateToFrench(c.date)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${c.status === 'paid' ? 'green' : 'red'}; font-weight: bold;">${c.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }

        /**
         * Handles printing a single credit (standard format).
         * @param {string} creditId - The ID of the credit to print.
         */
        function handlePrintSingleCreditStandard(creditId) {
            const credit = appData.credits.find(c => c.id === creditId);
            if (!credit) {
                addNotification('الكريدي غير موجود.', 'error');
                return;
            }

            // Centering the entire block and text within it
            const storeNameHtml = appData.storeName ? `<h1 style="text-align: center; margin-bottom: 10px; font-size: 22px; color: #333; font-weight: bold;">${appData.storeName}</h1>` : `<h1 style="text-align: center; margin-bottom: 10px; font-size: 22px; color: #333; font-weight: bold;">Quantix</h1>`;
            const pageTitle = `تفاصيل الكريدي - ${credit.customer} - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar" style="max-width: 400px; margin: 20px auto; text-align: center; padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
                    ${storeNameHtml}
                    <h2 style="margin-bottom: 20px; font-size: 20px; color: #1f2937; border-bottom: 1px solid #eee; padding-bottom: 10px;">وصل كريدي</h2>
                    <div style="text-align: right;">
                        <p style="margin-bottom: 10px; font-size: 14px;"><strong>التاريخ:</strong> ${formatDateToFrench(credit.date)}</p>
                        <p style="margin-bottom: 10px; font-size: 14px;"><strong>الزبون:</strong> ${credit.customer}</p>
                        <p style="margin-bottom: 10px; font-size: 14px;"><strong>المنتج/الخدمة:</strong> ${credit.product}</p>
                        <p style="margin-bottom: 10px; font-size: 16px; font-weight: bold;"><strong>المبلغ:</strong> ${credit.amount.toFixed(2)} د.م.</p>
                        <p style="margin-bottom: 15px; font-size: 14px;"><strong>الحالة:</strong> <span class="${credit.status === 'paid' ? 'status-paid' : 'status-unpaid'}">${credit.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}</span></p>
                    </div>
                    <svg class="barcode-svg" style="margin: 20px auto 0 auto; display: block;" data-value="CREDIT-${credit.id.slice(-8)}"></svg>
                </div>
            `;
            printContent(contentHtml, pageTitle, 'standard');
        }

        /**
         * Handles printing a single credit (thermal format).
         * @param {string} creditId - The ID of the credit to print.
         */
        function handlePrintSingleCreditThermal(creditId) {
            const credit = appData.credits.find(c => c.id === creditId);
            if (!credit) {
                addNotification('الكريدي غير موجود.', 'error');
                return;
            }

            const storeNameHtmlThermal = appData.storeName ? `<div class="store-name-thermal" style="font-size: 14pt; margin-bottom: 3mm;">${appData.storeName}</div>` : '<div class="store-name-thermal" style="font-size: 14pt; margin-bottom: 3mm;">Quantix</div>';
            const pageTitle = `كريدي ${credit.id.slice(-8)}`;
            const thankYouMessage = appData.storeName ? `شكراً لتعاملك مع ${appData.storeName}` : 'شكراً لتعاملك مع Quantix!';

            const contentHtml = `
                ${storeNameHtmlThermal}
                <div style="text-align: center; font-size: 10pt; margin-bottom: 2mm;">وصل كريدي</div>
                <div style="font-size: 8pt; text-align: right; margin-bottom: 2mm;"><strong>التاريخ:</strong> ${formatDateToFrench(credit.date)}</div>
                <div class="invoice-header-thermal">
                    <div><strong>الزبون:</strong> ${credit.customer}</div>
                    <div><strong>المنتج/الخدمة:</strong> ${credit.product}</div>
                    <div><strong>المبلغ:</strong> ${credit.amount.toFixed(2)} د.م.</div>
                    <div><strong>الحالة:</strong> ${credit.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}</div>
                </div>
                <svg class="barcode-svg" data-value="CREDIT-${credit.id.slice(-8)}"></svg>
                <div class="thank-you-thermal">${thankYouMessage}</div>
            `;
            printContent(contentHtml, pageTitle, 'thermal');
        }


        function handlePrintCart() {
            const total = appData.cartItems.reduce((sum, item) => {
                const product = appData.products.find(p => p.id === item.productId);
                return sum + (product ? product.price * item.quantity : 0);
            }, 0);

            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `السلة - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">السلة - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">المنتج</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الكمية</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">السعر للوحدة (د.م.)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الإجمالي (د.م.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appData.cartItems.map(item => {
                                const product = appData.products.find(p => p.id === item.productId);
                                if (!product) return '';
                                return `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${product.name}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.quantity}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${product.price.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${(item.quantity * product.price).toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div style="text-align: left; margin-top: 20px;">
                        <div style="font-weight: bold; font-size: 1.2em;">الإجمالي: ${total.toFixed(2)} د.م.</div>
                    </div>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }

        function handlePrintInvoice(invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                addNotification('الفاتورة غير موجودة.');
                return;
            }

            // عرض نافذة معاينة الطباعة الحرارية
            showThermalPrintPreview(invoice);
        }

        function showThermalPrintPreview(invoice) {
            // إنشاء معاينة الطباعة الحرارية
            const storeNameHtml = appData.storeName ? `<div class="store-name-thermal">${appData.storeName}</div>` : '<div class="store-name-thermal">Quantix</div>';
            const logoHtml = appData.storeLogo ? `<img src="${appData.storeLogo}" alt="شعار المحل" class="store-logo-thermal">` : '';
            const thankYouMessage = appData.storeName ? `شكراً لتعاملك مع ${appData.storeName}` : 'شكراً لتعاملك مع Quantix!';

            const previewHtml = `
                <div class="thermal-preview-container" style="
                    width: 320px; 
                    margin: 0 auto; 
                    padding: 20px; 
                    background: white; 
                    border: 1px solid #d1d5db; 
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    font-family: 'Segoe UI', 'Tahoma', 'Arial', 'Noto Sans Arabic', sans-serif;
                    font-size: 12px;
                    line-height: 1.6;
                    direction: rtl;
                    text-align: right;
                    unicode-bidi: bidi-override;
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                ">
                    <!-- Header Section with Logo and Store Name -->
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        text-align: center;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 1px solid #e5e7eb;
                    ">
                        ${appData.storeLogo ? `
                            <div style="
                                width: 50px;
                                height: 50px;
                                border-radius: 8px;
                                overflow: hidden;
                                margin-bottom: 10px;
                                border: 1px solid #e5e7eb;
                                background: #f9fafb;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <img src="${appData.storeLogo}" alt="شعار المحل" style="
                                    width: 100%;
                                    height: 100%;
                                    object-fit: contain;
                                ">
                            </div>
                        ` : ''}
                        <div style="
                            font-size: 16px;
                            font-weight: bold;
                            color: #111827;
                            margin-bottom: 6px;
                        ">${appData.storeName || 'Quantix'}</div>
                        <div style="
                            font-size: 10px;
                            color: #6b7280;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        ">فاتورة مبيعات</div>
                    </div>

                    <!-- Invoice Details -->
                    <div style="
                        text-align: right;
                        font-size: 10px;
                        margin-bottom: 15px;
                        line-height: 1.5;
                        background: #f9fafb;
                        padding: 8px;
                        border-radius: 6px;
                        border: 1px solid #e5e7eb;
                    ">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">رقم الفاتورة:</span>
                            <span style="font-weight: bold; color: #111827; font-size: 10px;">${invoice.invoiceNumber}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">العميل:</span>
                            <span style="font-weight: bold; color: #111827; font-size: 10px;">${invoice.customerName}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #6b7280; font-weight: 500;">التاريخ:</span>
                            <span style="font-weight: bold; color: #111827; font-size: 10px;">${formatDateToFrench(invoice.date)}</span>
                        </div>
                    </div>

                    <!-- Items List -->
                    <div style="
                        border-top: 1px dashed #9ca3af;
                        border-bottom: 1px dashed #9ca3af;
                        padding: 10px 0;
                        margin-bottom: 15px;
                    ">
                        ${invoice.items.map(item => `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-start;
                                margin-bottom: 8px;
                                padding-bottom: 6px;
                                border-bottom: 1px dotted #d1d5db;
                            ">
                                <div style="
                                    text-align: left;
                                    font-weight: bold;
                                    font-size: 10px;
                                ">
                                    ${(item.quantity * item.price).toFixed(2)} د.م.
                                </div>
                                <div style="
                                    flex: 1;
                                    text-align: right;
                                    padding-left: 10px;
                                ">
                                    <div style="
                                        font-weight: bold;
                                        font-size: 9px;
                                        margin-bottom: 2px;
                                        color: #111827;
                                    ">
                                        ${item.name}
                                    </div>
                                    <div style="
                                        font-size: 8px;
                                        color: #6b7280;
                                    ">
                                        ${item.quantity} × ${item.price.toFixed(2)} د.م.
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Total Section -->
                    <div style="
                        text-align: center;
                        margin-bottom: 20px;
                        padding: 10px 0;
                        border-top: 2px solid #111827;
                        border-bottom: 2px solid #111827;
                    ">
                        <div style="
                            font-size: 12px;
                            color: #6b7280;
                            margin-bottom: 4px;
                        ">المجموع الكلي</div>
                        <div style="
                            font-size: 18px;
                            font-weight: bold;
                            color: #111827;
                        ">
                            ${invoice.total.toFixed(2)} د.م.
                        </div>
                    </div>

                    <!-- Barcode Section -->
                    <div style="
                        display: flex;
                        justify-content: center;
                        margin-bottom: 15px;
                    ">
                        <svg class="barcode-preview" style="
                            width: 200px;
                            height: 40px;
                            border: 1px solid #e5e7eb;
                            border-radius: 4px;
                            background: white;
                        " data-value="INV-${invoice.invoiceNumber}"></svg>
                    </div>

                    <!-- Thank You Message -->
                    <div style="
                        text-align: center;
                        font-size: 9px;
                        color: #6b7280;
                        font-style: italic;
                        padding-top: 10px;
                        border-top: 1px solid #e5e7eb;
                    ">
                        ${thankYouMessage}
                    </div>
                </div>
            `;

            const modalHtml = `
                <div class="space-y-4">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">معاينة الطباعة الحرارية</h3>
                        ${previewHtml}
                    </div>
                    <div class="flex justify-center gap-3 mt-6">
                        <button id="cancel-thermal-print" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                            إلغاء
                        </button>
                        <button id="confirm-thermal-print" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition duration-200">
                            تأكيد الطباعة
                        </button>
                    </div>
                </div>
            `;

            showGenericModal("طباعة حرارية", modalHtml);

            // إنشاء الباركود في المعاينة
            setTimeout(() => {
                const barcodeElement = document.querySelector('.barcode-preview');
                if (barcodeElement && window.JsBarcode) {
                    try {
                        window.JsBarcode(barcodeElement, `INV-${invoice.invoiceNumber}`, {
                            format: "CODE128",
                            displayValue: true,
                            width: 1.5,
                            height: 40,
                            margin: 2,
                            fontSize: 10,
                            textMargin: 0,
                        });
                    } catch (e) {
                        console.error("Error generating barcode preview:", e);
                    }
                }
            }, 100);

            // إضافة أحداث الأزرار
            document.getElementById('cancel-thermal-print').onclick = hideGenericModal;
            document.getElementById('confirm-thermal-print').onclick = () => {
                hideGenericModal();
                proceedWithThermalPrint(invoice);
            };
        }

        function proceedWithThermalPrint(invoice) {
            // تجهيز بيانات الفاتورة للإرسال إلى العملية الرئيسية
            const invoiceDataForMain = {
                storeName: appData.storeName || 'Quantix',
                storeLogoDataUrl: appData.storeLogo, // إرسال شعار المتجر كـ Data URL
                invoiceNumber: invoice.invoiceNumber,
                customerName: invoice.customerName,
                date: formatDateToFrench(invoice.date), 
                items: invoice.items.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    total: (item.quantity * item.price)
                })),
                total: invoice.total,
                thankYouMessage: appData.storeName ? `شكراً لتعاملك مع ${appData.storeName}` : 'شكراً لتعاملك مع Quantix!'
            };

            // استدعاء الدالة المكشوفة من preload.js
            if (window.electronAPI && typeof window.electronAPI.printInvoice === 'function') {
                try {
                    window.electronAPI.printInvoice(invoiceDataForMain);
                    // لا تحتاج لإظهار showToast هنا، سيتم التعامل معه عبر onPrintStatus
                } catch (error) {
                    console.error('Error calling electronAPI.printInvoice:', error);
                    showToast('حدث خطأ أثناء محاولة إرسال الفاتورة للطباعة.', 'error');
                }
            } else {
                console.error('electronAPI.printInvoice is not available. Check preload.js and main.js webPreferences.');
                showToast('وظيفة طباعة الفاتورة الحرارية غير متوفرة. تحقق من إعدادات التطبيق.', 'error');
            }
        }

        // دالة لتوليد باركود Code128
        function generateBarcodeDataURL(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // إعداد أبعاد الباركود
            const barWidth = 2;
            const barHeight = 50;
            const textHeight = 20;
            
            // حساب عرض الباركود
            const barcodeWidth = text.length * 12 * barWidth;
            canvas.width = barcodeWidth;
            canvas.height = barHeight + textHeight;
            
            // رسم خلفية بيضاء
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // رسم الباركود (نمط بسيط)
            ctx.fillStyle = '#000000';
            let x = 0;
            
            // رسم أشرطة الباركود
            for (let i = 0; i < text.length; i++) {
                const char = text.charCodeAt(i);
                const pattern = char % 2 === 0 ? [1, 0, 1, 0, 1, 1] : [1, 1, 0, 1, 0, 1];
                
                for (let j = 0; j < pattern.length; j++) {
                    if (pattern[j] === 1) {
                        ctx.fillRect(x, 0, barWidth, barHeight);
                    }
                    x += barWidth;
                }
            }
            
            // إضافة النص تحت الباركود
            ctx.fillStyle = '#000000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, barHeight + 15);
            
            return canvas.toDataURL('image/png');
        }

        function handlePrintInvoiceStandard(invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                addNotification('الفاتورة غير موجودة.');
                return;
            }

            // إعداد محتوى الطباعة للفاتورة
            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `فاتورة - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">فاتورة - Quantix</h1>
                    ${storeNameHtml}
                    <p><strong>رقم الفاتورة:</strong> ${invoice.invoiceNumber}</p>
                    <p><strong>اسم الزبون:</strong> ${invoice.customerName}</p>
                    <p><strong>التاريخ:</strong> ${formatDateToFrench(invoice.date)}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">المنتج</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الكمية</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">السعر (د.م.)</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الإجمالي (د.م.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.quantity}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${item.price.toFixed(2)}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${(item.quantity * item.price).toFixed(2)}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="text-align: left; margin-top: 20px;">
                        <div style="font-weight: bold; font-size: 1.2em;">الإجمالي: ${invoice.total.toFixed(2)} د.م.</div>
                    </div>
                    <svg class="barcode-svg" style="margin: 20px auto; display: block;" data-value="INV-${invoice.invoiceNumber}"></svg>
                </div>
                </div>
            `;
            printContent(contentHtml, pageTitle, 'standard');
        }

        function handlePrintInvoicesList() {
            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `قائمة الفواتير - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">قائمة الفواتير - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">رقم الفاتورة</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">اسم الزبون</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">التاريخ</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الإجمالي (د.م.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appData.invoices.map(inv => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${inv.invoiceNumber}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${inv.customerName}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatDateToFrench(inv.date)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${inv.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }

        /**
         * NEW: Handles printing the list of suppliers (standard format).
         */
        function handlePrintSuppliersList() {
            let suppliersToPrint = [...appData.suppliers];
            // Apply current search and sort filters (if any)
            appData.searchTerm = searchInput.value.trim();
            if (appData.searchTerm) {
                suppliersToPrint = suppliersToPrint.filter(s =>
                    s.name.toLowerCase().includes(appData.searchTerm.toLowerCase()) ||
                    (s.company && s.company.toLowerCase().includes(appData.searchTerm.toLowerCase())) ||
                    (s.phone && s.phone.includes(appData.searchTerm)) ||
                    (s.email && s.email.toLowerCase().includes(appData.searchTerm.toLowerCase()))
                );
            }
            const sortOption = suppliersSortSelect.value;
            switch (sortOption) {
                case 'name-asc': suppliersToPrint.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': suppliersToPrint.sort((a, b) => b.name.localeCompare(a.name)); break;
                case 'company-asc': suppliersToPrint.sort((a, b) => (a.company || '').localeCompare(b.company || '')); break;
                case 'company-desc': suppliersToPrint.sort((a, b) => (b.company || '').localeCompare(a.company || '')); break;
                default: break;
            }

            const storeNameHtml = appData.storeName ? `<p style="text-align: center; margin-bottom: 20px; font-size: 18px; color: #555;">${appData.storeName}</p>` : '';
            const pageTitle = `قائمة الموردين - ${appData.storeName || 'Quantix'}`;

            const contentHtml = `
                <div class="printable-content" dir="rtl" lang="ar">
                    <h1 style="text-align: center; margin-bottom: 5px; font-size: 24px; color: #1f2937;">قائمة الموردين - Quantix</h1>
                    ${storeNameHtml}
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الاسم</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الشركة</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">الهاتف</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">البريد الإلكتروني</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">العنوان</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${suppliersToPrint.map(s => `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${s.name}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${s.company || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${s.phone}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${s.email || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${s.address || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            printContent(contentHtml, pageTitle);
        }
        // --- Data Backup/Restore Functions ---

        /**
         * Downloads current app data as a JSON file.
         */
        function handleBackupData() {
            try {
                // Convert Date objects to ISO strings for proper JSON serialization
                const dataToBackup = {
                    products: appData.products,
                    credits: appData.credits.map(c => ({ ...c, date: c.date.toISOString() })),
                    invoices: appData.invoices.map(i => ({ ...i, date: i.date.toISOString() })),
                    suppliers: appData.suppliers, // NEW: Include suppliers
                    directSales: appData.directSales, // NEW: Include direct sales in backup
                    debts: appData.debts.map(d => ({ // NEW: Include debts
                        ...d,
                        creationDate: d.creationDate instanceof Date && !isNaN(d.creationDate.getTime()) ? d.creationDate.toISOString() : null,
                        dueDate: d.dueDate instanceof Date && !isNaN(d.dueDate.getTime()) ? d.dueDate.toISOString() : null
                    })),

                    cartItems: appData.cartItems,
                    notifications: appData.notifications.map(n => ({ ...n, date: n.date.toISOString(), read: n.read })), // Save read status
                    dailySales: {
                        date: appData.dailySales.date, // AlreadyYYYY-MM-DD string
                        hourlySales: appData.dailySales.hourlySales
                    },
                    monthlySalesData: appData.monthlySalesData,
                    weeklySalesData: appData.weeklySalesData,
                    storeName: appData.storeName,
                    storeLogo: appData.storeLogo, // NEW: Include store logo in backup
                    activeTab: appData.activeTab
                };
                const json = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quantix_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Release object URL
                addNotification('تم تنزيل نسخة احتياطية من البيانات.', 'success');
            } catch (e) {
                console.error("Error during backup:", e);
                addNotification("فشل إنشاء النسخة الاحتياطية.", 'error');
            }
        }

        /**
         * Triggers the file input for data restoration.
         */
        function handleRestoreData() {
            restoreFileInput.click(); // Trigger hidden file input
        }

        /**
         * Handles the selected file for restoration.
         * @param {Event} event - The file input change event.
         */
        function handleRestoreFileChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        showConfirmationModal('هل أنت متأكد أنك تريد استعادة البيانات؟ سيؤدي هذا إلى استبدال البيانات الحالية بالبيانات الموجودة في الملف.', () => {
                            // Restore appData with loaded data
                            appData.products = loadedData.products || [];
                            // Ensure costPrice is set for all products, default to 0 if missing
                            appData.products.forEach(p => {
                                if (p.costPrice === undefined || p.costPrice === null) {
                                    p.costPrice = 0;
                                }
                            });

                            appData.credits = (loadedData.credits || []).map(c => ({ ...c, date: new Date(c.date) }));
                            appData.invoices = (loadedData.invoices || []).map(i => ({ ...i, date: new Date(i.date) }));
                            appData.cartItems = loadedData.cartItems || [];
                            appData.suppliers = loadedData.suppliers || []; // NEW: Restore suppliers
                            appData.directSales = loadedData.directSales || []; // NEW: Restore direct sales
                            appData.debts = (loadedData.debts || []).map(d => ({ // NEW: Restore debts
                                ...d,
                                creationDate: new Date(d.creationDate),
                                dueDate: new Date(d.dueDate)
                            }));
                            appData.notifications = (loadedData.notifications || []).map(n => ({ ...n, date: new Date(n.date) }));

                            // Handle chart specific data restoration
                            appData.dailySales = {
                                date: loadedData.dailySales?.date || new Date().toISOString().slice(0, 10),
                                hourlySales: loadedData.dailySales?.hourlySales || Array(24).fill(0)
                            };
                            appData.monthlySalesData = loadedData.monthlySalesData || {};
                            appData.weeklySalesData = loadedData.weeklySalesData || {};
                            appData.storeName = loadedData.storeName || ''; // NEW: Restore store name
                            appData.storeLogo = loadedData.storeLogo || null; // NEW: Restore store logo
                            currentStoreLogoSrc = appData.storeLogo; // NEW: Update session variable

                            updateInventoryCategoryFilterOptions(); // Update category filter based on restored products
                            saveData(); // Save restored data to localStorage
                            addNotification('تمت استعادة البيانات بنجاح.', 'success');
                            renderContent(); // Re-render all sections
                            updateStoreLogoDisplay(); 
                            hideGenericModal(); // Close settings modal if it was open
                        });
                    }
                     catch (error) {
                        addNotification('خطأ في قراءة ملف النسخ الاحتياطي. تأكد من أنه ملف JSON صالح.', 'error');
                        console.error('Error parsing JSON for restore:', error);
                    }
                };
                reader.readAsText(file);
            }
            // Clear the file input value to allow selecting the same file again
            event.target.value = '';
        }

        // --- Event Listeners Attachment ---

        /**
         * Attaches event listeners for elements that are dynamically added/updated in the Inventory section.
         */
        function attachInventoryEventListeners() {
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.add-to-cart-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handleAddToCart(e.target.dataset.productId);
            });
            document.querySelectorAll('.edit-product-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => {
                    appData.productToEditId = e.target.closest('button').dataset.productId;
                    renderAddEditProductModal();
                };
            });
            document.querySelectorAll('.delete-product-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handleDeleteProduct(e.target.closest('button').dataset.productId);
            });
        }

        /**
         * Attaches event listeners for elements that are dynamically added/updated in the Credit section.
         */
        function attachCreditEventListeners() {
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.edit-credit-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => {
                    appData.creditToEditId = e.target.closest('button').dataset.creditId;
                    renderAddEditCreditModal();
                };
            });
            document.querySelectorAll('.mark-paid-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handleMarkCreditAsPaid(e.target.dataset.creditId);
            });
            document.querySelectorAll('.delete-credit-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handleDeleteCredit(e.target.dataset.creditId);
            });
            document.querySelectorAll('.print-credit-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handlePrintSingleCreditStandard(e.target.closest('button').dataset.creditId);
            });
            document.querySelectorAll('.print-credit-thermal-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => handlePrintSingleCreditThermal(e.target.closest('button').dataset.creditId);
            });

        }

        /**
         * Attaches event listeners for elements that are dynamically added/updated in the Invoices section.
         */
        function attachInvoiceEventListeners() {
            // Remove existing listeners to prevent duplicates
            document.querySelectorAll('.print-invoice-standard-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => {
                    const invoiceId = e.target.closest('button').dataset.invoiceId;
                    console.log('Standard print button clicked for invoice:', invoiceId);
                    handlePrintInvoiceStandard(invoiceId);
                };
            });
            document.querySelectorAll('.view-print-invoice-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => {
                    const invoiceId = e.target.closest('button').dataset.invoiceId;
                    console.log('Thermal print button clicked for invoice:', invoiceId);
                    handlePrintInvoice(invoiceId);
                };
            });
            document.querySelectorAll('.delete-invoice-button').forEach(button => {
                button.onclick = null; // Clear existing
                button.onclick = (e) => {
                    const invoiceId = e.target.closest('button').dataset.invoiceId;
                    console.log('Delete button clicked for invoice:', invoiceId);
                    handleDeleteInvoice(invoiceId);
                };
            });
        }

        /**
         * NEW: Attaches event listeners for elements that are dynamically added/updated in the Suppliers section.
         */
        function attachSupplierEventListeners() {
            document.querySelectorAll('.edit-supplier-button').forEach(button => {
                button.onclick = null;
                button.onclick = (e) => {
                    appData.supplierToEditId = e.target.closest('button').dataset.supplierId;
                    renderAddEditSupplierModal();
                };
            });
            document.querySelectorAll('.delete-supplier-button').forEach(button => {
                button.onclick = null;
                button.onclick = (e) => handleDeleteSupplier(e.target.closest('button').dataset.supplierId);
            });
        }

        /**
         * NEW: Attaches event listeners for elements that are dynamically added/updated in the Debts section.
         */
        function attachDebtEventListeners() {
            document.querySelectorAll('.edit-debt-button').forEach(button => {
                button.onclick = null;
                button.onclick = (e) => {
                    appData.debtToEditId = e.target.closest('button').dataset.debtId;
                    renderAddEditDebtModal();
                };
            });
            document.querySelectorAll('.mark-debt-paid-button').forEach(button => {
                button.onclick = null;
                button.onclick = (e) => handleMarkDebtAsPaid(e.target.dataset.debtId);
            });
            document.querySelectorAll('.delete-debt-button').forEach(button => {
                button.onclick = null;
                button.onclick = (e) => handleDeleteDebt(e.target.closest('button').dataset.debtId);
            });
        }

        /**
         * Initializes all global event listeners.
         */
        function attachGlobalEventListeners() {
            searchInput.addEventListener('input', (e) => {
                appData.searchTerm = e.target.value;
                renderContent(); // Re-render active section with new search term
            });
        inventoryCategoryFilter.onchange = renderInventorySection;
            cartButton.onclick = () => renderCartModal();
            notificationsButton.onclick = (e) => {
                e.stopPropagation(); // Prevent modal from closing immediately if clicked on dot
                renderNotificationsModal();
            };
            // Allow clicking outside the modal to close notifications modal
            document.addEventListener('click', (e) => {
                // Check if the click is outside the generic modal AND the notifications button itself
                if (!genericModal.classList.contains('hidden') &&
                    genericModalTitle.textContent === 'الإشعارات' &&
                    !genericModal.contains(e.target) &&
                    !notificationsButton.contains(e.target)) {
                    hideGenericModal();
                }
            });
            undoLastTransactionButton.onclick = handleUndoLastTransaction;
            resetCartStockButton.onclick = handleResetCartAndStock;

            settingsButton.onclick = () => renderSettingsModal();
            genericModalCloseButton.onclick = hideGenericModal;

            // إغلاق النافذة المنبثقة العامة عند الضغط على خلفيتها
            genericModal.addEventListener('click', function(event) {
                // التحقق مما إذا كان الضغط مباشرة على عنصر الخلفية للنافذة المنبثقة
                if (event.target === genericModal) {
                    hideGenericModal();
                }
            });

            confirmModalCancelButton.onclick = handleCancelAction;
            confirmModalConfirmButton.onclick = handleConfirmAction;
            confirmModalCloseButton.onclick = hideConfirmationModal;

            storeProfileButton.onclick = renderStoreNameModal; // NEW: Event listener for store profile button

            navItems.forEach(item => {
                item.onclick = (e) => {
                    navItems.forEach(nav => nav.classList.remove('bg-blue-600', 'text-white', 'shadow-md'));
                    navItems.forEach(nav => nav.classList.add('text-gray-300', 'hover:bg-gray-700')); // Reset
                    e.currentTarget.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    e.currentTarget.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                    appData.activeTab = e.currentTarget.dataset.tab;
                    saveData(); // Save active tab
                    renderContent();
                };
            });

            // Inventory listeners            
            inventorySortSelect.onchange = renderInventorySection;
            inventoryCategoryFilter.onchange = renderInventorySection; // Moved here for consistency
            addProductButton.onclick = () => {
                appData.productToEditId = null; // Ensure we are adding a new product
                renderAddEditProductModal();
            };

            // Credit listeners
            creditStatusFilter.onchange = renderCreditSection;
            creditSortSelect.onchange = renderCreditSection;
            addCreditButton.onclick = () => {
                appData.creditToEditId = null; // Ensure we are adding a new credit
                renderAddEditCreditModal();
            };
            printCreditsButton.onclick = handlePrintCredits;

            // Invoices listeners
            if (printInvoicesListButton) printInvoicesListButton.onclick = handlePrintInvoicesList;

            // Reports listeners
            // Backup/Restore buttons are now part of the ReportsManager HTML, event listeners are set up there if needed
            // Or, if they are meant to be global, they should be outside the reports-section managed by ReportsManager

            // Suppliers listeners (NEW)
            if (suppliersSortSelect) suppliersSortSelect.onchange = renderSuppliersSection;
            if (addSupplierButton) {
                addSupplierButton.onclick = () => {
                    appData.supplierToEditId = null;
                    renderAddEditSupplierModal();
                };
            }

            if (printSuppliersButton) printSuppliersButton.onclick = handlePrintSuppliersList;
            // Resize observer for charts
            // Only observe the reports section container
            // The following lines related to backupDataButton and restoreDataButton are likely causing issues
            // if these elements are not globally available. Their event handlers are set within renderSettingsModal.
            // if (backupDataButton) backupDataButton.onclick = handleBackupData; // Consider removing or making conditional
            // if (restoreDataButton) restoreDataButton.onclick = handleRestoreData; // Consider removing or making conditional
            
            if (restoreFileInput) { // Ensure restoreFileInput exists before assigning onchange
                restoreFileInput.onchange = handleRestoreFileChange;
            }

               if (printProductsButton) printProductsButton.onclick = handlePrintProducts;

            // Debts listeners (NEW)
            if (debtStatusFilter) debtStatusFilter.onchange = renderDebtsSection;
            if (debtSortSelect) debtSortSelect.onchange = renderDebtsSection;
            if (addDebtButton) {
                addDebtButton.onclick = () => {
                    appData.debtToEditId = null;
                    renderAddEditDebtModal();
                };
            }
            if (printDebtsButton) printDebtsButton.onclick = handlePrintDebtsList;
 


        }
        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Load data from localStorage
            // Initialize search input with empty string, not undefined
            if (searchInput) {
                searchInput.value = ''; // Ensure it's explicitly empty
            }
            updateInventoryCategoryFilterOptions(); // Populate category filter on initial load
            attachGlobalEventListeners(); // Attach all event listeners
            const initialNavItem = document.querySelector(`.nav-item[data-tab="${appData.activeTab}"]`);
            if (initialNavItem) {
                navItems.forEach(nav => nav.classList.remove('bg-blue-600', 'text-white', 'shadow-md'));
                navItems.forEach(nav => nav.classList.add('text-gray-300', 'hover:bg-gray-700')); // Reset all nav items
                initialNavItem.classList.remove('text-gray-300', 'hover:bg-gray-700');
                initialNavItem.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }
            renderContent(); // Render initial content based on active tab
            updateStoreLogoDisplay(); // Ensure logo (if any from previous session logic, though not saved) or default is shown
            updateUndoResetButtonsState(); // Set initial state of new buttons

            // الاستماع لرسائل حالة الطباعة من العملية الرئيسية
            if (window.electronAPI && typeof window.electronAPI.onPrinterSettingsSavedStatus === 'function') {
                window.electronAPI.onPrinterSettingsSavedStatus(status => {
                    const statusDiv = document.getElementById('printer-status-message');
                    if (status.success) {
                        showToast(status.message, 'success');
                        if (statusDiv) {
                            statusDiv.textContent = status.message;
                            statusDiv.className = 'mt-2 text-sm text-green-600';
                        }
                        // تحديث الحقول في النموذج إذا تم إرسال الإعدادات الجديدة
                        if (status.newSettings && document.getElementById('printer-interface-input')) {
                             document.getElementById('printer-interface-input').value = status.newSettings.interface;
                             document.getElementById('printer-type-select').value = status.newSettings.typeKey;
                             document.getElementById('printer-charset-select').value = status.newSettings.characterSetKey;
                        }
                    } else {
                        showToast(status.message || 'فشل حفظ إعدادات الطابعة.', 'error');
                        if (statusDiv) {
                            statusDiv.textContent = status.message || 'فشل حفظ إعدادات الطابعة.';
                            statusDiv.className = 'mt-2 text-sm text-red-600';
                        }
                    }
                });
            }

            // الاستماع لنتائج اكتشاف الطابعات
            if (window.electronAPI && typeof window.electronAPI.onDiscoveredPrinters === 'function') {
                window.electronAPI.onDiscoveredPrinters(result => {
                    const statusDiv = document.getElementById('printer-status-message');
                    displayDiscoveredPrinters(result.printers, statusDiv, result.message);
                    if (result.message) showToast(result.message, result.success ? 'info' : 'warning');
                });
            }

        });

        async function handleSavePrinterConfig() {
            const printerInterface = document.getElementById('printer-interface-input').value;
            const printerType = document.getElementById('printer-type-select').value;
            const printerCharset = document.getElementById('printer-charset-select').value;
            const statusDiv = document.getElementById('printer-status-message');

            if (!printerInterface) {
                if (statusDiv) {
                    statusDiv.textContent = 'الرجاء إدخال واجهة الطابعة.';
                    statusDiv.className = 'mt-2 text-sm text-red-600';
                }
                return;
            }
            // لا يوجد إجراء فوري هنا، سيتم تحديث الواجهة عبر onPrinterSettingsSavedStatus
            window.electronAPI.savePrinterSettings({
                interface: printerInterface,
                type: printerType,
                characterSet: printerCharset
            });
        }

        async function handleTestPrinterConnection() {
            const printerInterface = document.getElementById('printer-interface-input').value;
            const printerType = document.getElementById('printer-type-select').value;
            const printerCharset = document.getElementById('printer-charset-select').value;
            const statusDiv = document.getElementById('printer-status-message');

            if (!window.electronAPI || typeof window.electronAPI.testPrinterConnection !== 'function') {
                console.error('Error testing printer connection: electronAPI or testPrinterConnection is not available.');
                if (statusDiv) {
                    statusDiv.textContent = 'خطأ: واجهة برمجة تطبيقات الطابعة غير متوفرة. الرجاء إعادة تشغيل التطبيق.';
                    statusDiv.className = 'mt-2 text-sm text-red-600';
                }
                showToast('واجهة برمجة تطبيقات الطابعة غير متوفرة. تأكد من أن التطبيق يعمل بشكل صحيح.', 'error');
                return;
            }


            if (!printerInterface) {
                if (statusDiv) {
                    statusDiv.textContent = 'الرجاء إدخال واجهة الطابعة لاختبار الاتصال.';
                    statusDiv.className = 'mt-2 text-sm text-red-600';
                }
                return;
            }
            if (statusDiv) {
                statusDiv.textContent = 'جاري اختبار الاتصال...';
                statusDiv.className = 'mt-2 text-sm text-blue-600';
            }

            try {
                const result = await window.electronAPI.testPrinterConnection({
                    interface: printerInterface,
                    type: printerType,
                    characterSet: printerCharset
                });
                if (statusDiv) {
                    statusDiv.textContent = result.message;
                    statusDiv.className = `mt-2 text-sm ${result.success ? 'text-green-600' : 'text-red-600'}`;
                }
                showToast(result.message, result.success ? 'success' : 'error');
            } catch (error) {
                console.error('Error testing printer connection:', error);
                const errorMessage = error.message || 'فشل اختبار الاتصال بشكل غير متوقع.';
                if (statusDiv) {
                    statusDiv.textContent = `خطأ: ${errorMessage}`;
                    statusDiv.className = 'mt-2 text-sm text-red-600';
                }
                showToast(`خطأ في اختبار الاتصال: ${errorMessage}`, 'error');
            }
        }

        function handleDiscoverPrinters() {
            const statusDiv = document.getElementById('printer-status-message');
            if (statusDiv) {
                statusDiv.textContent = 'جاري البحث عن الطابعات...';
                statusDiv.className = 'mt-2 text-sm text-blue-600';
            }
            if (window.electronAPI && window.electronAPI.discoverPrinters) {
                window.electronAPI.discoverPrinters();
            } else {
                if (statusDiv) {
                    statusDiv.textContent = 'وظيفة البحث عن الطابعات غير متاحة.';
                    statusDiv.className = 'mt-2 text-sm text-red-600';
                }
            }
        }

        function displayDiscoveredPrinters(printers, statusDiv, message) {
            if (!statusDiv) return;

            let printersHtml = `<p class="text-gray-600 mb-2">${message || 'الطابعات المقترحة (انقر للتحديد):'}</p>`;
            if (printers && printers.length > 0) {
                printersHtml += '<ul class="list-disc pl-5 space-y-1 max-h-32 overflow-y-auto border p-2 rounded-md">';
                printers.forEach(p => {
                    printersHtml += `<li><a href="#" class="text-blue-600 hover:underline discovered-printer-item" data-interface="${p.interface}">${p.name} (${p.interface})</a></li>`;
                });
                printersHtml += '</ul>';
            } else if (!message) { // Only show "no printers" if no other message was provided
                printersHtml = '<p class="text-gray-600">لم يتم العثور على طابعات مقترحة. الرجاء الإدخال اليدوي.</p>';
            }
            statusDiv.innerHTML = printersHtml;
            statusDiv.className = 'mt-2 text-sm text-gray-700'; // Neutral color for list

            document.querySelectorAll('.discovered-printer-item').forEach(item => {
                item.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById('printer-interface-input').value = e.target.dataset.interface;
                    statusDiv.innerHTML = `<p class="text-green-600">تم تحديد الواجهة: ${e.target.dataset.interface}. يمكنك الآن اختبار الاتصال أو الحفظ.</p>`;
                };
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ... (الكود الموجود مسبقاً) ...

            // الاستماع لرسائل حالة الطباعة من العملية الرئيسية (موجود بالفعل)
            if (window.electronAPI && typeof window.electronAPI.onPrintStatus === 'function') {
                window.electronAPI.onPrintStatus((status) => {
                    if (status.success) {
                        showToast(status.message || 'تم إرسال الفاتورة للطباعة بنجاح.', 'success');
                    } else {
                        showToast(status.message || 'فشل إرسال الفاتورة للطباعة.', 'error');
                    }
                });
            }
        });

    </script>
</body>
</html>
